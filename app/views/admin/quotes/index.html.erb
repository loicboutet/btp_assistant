<% content_for :title, "Tous les Devis - Admin" %>

<div class="admin-page-header">
  <h1>Tous les Devis</h1>
  <p class="text-muted"><%= Quote.count %> devis</p>
</div>

<!-- Filters -->
<div class="admin-card" style="margin-bottom: var(--spacing-lg);">
  <h3 class="filters-title">Filtres de recherche</h3>

  <%= form_with url: admin_quotes_path, method: :get, local: true, class: "filters-bar" do %>
    <div class="search-box">
      <%= text_field_tag :q, params[:q], type: :search, placeholder: "Rechercher par numéro, client, entreprise...", class: "form-input" %>
    </div>

    <div class="filter-group">
      <%= select_tag :status,
            options_for_select([
              ["Tous les statuts", ""],
              ["Brouillon", "draft"],
              ["Envoyé", "sent"],
              ["Accepté", "accepted"],
              ["Refusé", "rejected"]
            ], params[:status]),
            class: "form-select" %>
    </div>

    <div class="filter-group">
      <%= select_tag :user_id,
            options_for_select([["Tous les utilisateurs", ""]] + @users_for_filter.map { |u| [u.display_name, u.id] }, params[:user_id]),
            class: "form-select" %>
    </div>

    <div class="filter-group">
      <%= select_tag :period,
            options_for_select([
              ["Toutes les périodes", ""],
              ["Aujourd'hui", "today"],
              ["Cette semaine", "week"],
              ["Ce mois", "month"],
              ["Ce trimestre", "quarter"]
            ], params[:period]),
            class: "form-select" %>
    </div>

    <div class="filter-actions">
      <%= link_to admin_quotes_path, class: "btn btn-outline" do %>
        <span>Effacer</span>
      <% end %>
      <button class="btn btn-primary" type="submit">
        <span>Filtrer</span>
      </button>
    </div>
  <% end %>
</div>

<div class="admin-card">
  <div class="table-responsive" data-controller="table-scroll">
    <table class="admin-table">
      <thead>
        <tr>
          <th>Numéro</th>
          <th>Utilisateur</th>
          <th>Client</th>
          <th>Date émission</th>
          <th>Validité</th>
          <th>Montant TTC</th>
          <th>Statut</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <% @quotes.each do |quote| %>
          <tr>
            <td data-label="Numéro"><%= quote.quote_number %></td>
            <td data-label="Utilisateur">
              <div class="user-info-compact">
                <div class="user-avatar-sm"><%= quote.user.display_name.to_s.first(2).upcase %></div>
                <span><%= quote.user.display_name %></span>
              </div>
            </td>
            <td data-label="Client">
              <div><%= quote.client.name %></div>
              <div class="text-muted small"><%= quote.client.siret.present? ? "SIRET: #{quote.client.siret}" : "Particulier" %></div>
            </td>
            <td data-label="Date"><%= l(quote.issue_date) %></td>
            <td data-label="Validité">
              <% if quote.validity_date.present? %>
                <div><%= (quote.validity_date - quote.issue_date).to_i %>j</div>
                <div class="text-muted small">Expire <%= l(quote.validity_date) %></div>
              <% else %>
                -
              <% end %>
            </td>
            <td data-label="Montant" class="font-weight-bold"><%= quote.formatted_total %></td>
            <td data-label="Statut"><span class="status-badge"><%= quote.status %></span></td>
            <td data-label="Actions">
              <%= link_to quote_admin_user_path(quote.user, quote_id: quote.id), class: "btn btn-xs btn-outline" do %>
                <span>Voir</span>
              <% end %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
</div>

<%= render 'shared/pagination', collection: @quotes %>
