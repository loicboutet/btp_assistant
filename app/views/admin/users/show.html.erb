<% content_for :title, "Utilisateur - #{@user.display_name}" %>

<div class="admin-page-header">
  <div class="header-with-actions">
    <div>
      <%= link_to "â† Retour aux utilisateurs", admin_users_path, class: "back-link" %>
      <h1><%= @user.display_name %></h1>
      <p class="text-muted"><%= @user.company_name.presence || '-' %> â€¢ Inscrit le <%= l(@user.created_at.to_date) %></p>
    </div>
    <div class="header-actions">
      <%= link_to edit_admin_user_path(@user), class: "btn btn-primary" do %>
        <span>Modifier</span>
      <% end %>

      <%= link_to stripe_portal_admin_user_path(@user), class: "btn btn-outline" do %>
        <span>Stripe</span>
      <% end %>

      <% if @user.subscription_status == 'active' %>
        <%= link_to suspend_admin_user_path(@user), method: :post, class: "btn btn-danger", data: { confirm: "ÃŠtes-vous sÃ»r de vouloir suspendre ce compte ?" } do %>
          <span>Suspendre</span>
        <% end %>
      <% else %>
        <%= link_to activate_admin_user_path(@user), method: :post, class: "btn btn-primary", data: { confirm: "Activer ce compte ?" } do %>
          <span>Activer</span>
        <% end %>
      <% end %>
    </div>
  </div>
</div>

<!-- User Overview Cards -->
<div class="stats-grid">
  <div class="stat-card">
    <div class="stat-icon bg-purple">ğŸ“„</div>
    <div class="stat-content">
      <div class="stat-value"><%= @quotes_count + @invoices_count %></div>
      <div class="stat-label">Documents gÃ©nÃ©rÃ©s</div>
      <div class="stat-detail"><%= @quotes_count %> devis, <%= @invoices_count %> factures</div>
    </div>
  </div>
  <div class="stat-card">
    <div class="stat-icon bg-blue">ğŸ‘¥</div>
    <div class="stat-content">
      <div class="stat-value"><%= @clients_count %></div>
      <div class="stat-label">Clients</div>
      <div class="stat-detail">Total</div>
    </div>
  </div>
  <div class="stat-card">
    <div class="stat-icon bg-green">ğŸ’°</div>
    <div class="stat-content">
      <div class="stat-value"><%= @user.subscription_status %></div>
      <div class="stat-label">Abonnement</div>
      <div class="stat-detail">
        <% if @subscription.present? && @subscription.current_period_end.present? %>
          Prochaine Ã©chÃ©ance: <%= l(@subscription.current_period_end.to_date) %>
        <% else %>
          -
        <% end %>
      </div>
    </div>
  </div>
  <div class="stat-card">
    <div class="stat-icon bg-orange">ğŸ’¬</div>
    <div class="stat-content">
      <div class="stat-value <%= @whatsapp_connected ? 'success-text' : '' %>"><%= @whatsapp_connected ? 'ConnectÃ©' : 'Non connectÃ©' %></div>
      <div class="stat-label">WhatsApp</div>
      <div class="stat-detail"><%= @user.formatted_phone %></div>
    </div>
  </div>
</div>

<!-- AccÃ¨s & Abonnement Section -->
<div class="admin-card" style="margin-bottom: var(--spacing-xl);">
  <div class="card-header">
    <h2>AccÃ¨s & Abonnement</h2>
  </div>
  <div class="details-list">
    <div class="detail-item">
      <span class="detail-label">AccÃ¨s gratuit</span>
      <span class="detail-value">
        <% if @user.bypass_subscription %>
          <span class="status-badge status-success">ğŸ AccÃ¨s gratuit</span>
        <% else %>
          <span class="status-badge">Non</span>
        <% end %>
      </span>
    </div>
    <div class="detail-item">
      <span class="detail-label">PÃ©riode d'essai</span>
      <span class="detail-value">
        <% if @user.in_trial_period? %>
          <span class="status-badge status-warning">â³ PÃ©riode d'essai: <%= @user.trial_days_remaining %> jours restants</span>
        <% elsif @user.trial_expired? && @user.subscription_status != 'active' && !@user.bypass_subscription %>
          <span class="status-badge status-danger">âŒ PÃ©riode d'essai expirÃ©e</span>
        <% elsif @user.trial_ends_at.present? %>
          <span class="status-badge">TerminÃ©e</span>
        <% else %>
          <span class="status-badge">Non dÃ©finie</span>
        <% end %>
      </span>
    </div>
    <% if @user.trial_ends_at.present? %>
      <div class="detail-item">
        <span class="detail-label">Date de fin d'essai</span>
        <span class="detail-value"><%= l(@user.trial_ends_at) %></span>
      </div>
    <% end %>
  </div>
</div>

<!-- Quick Links -->
<div class="stats-grid" style="margin-bottom: var(--spacing-xl);">
  <%= link_to clients_admin_user_path(@user), class: "stat-card", style: "text-decoration: none;" do %>
    <div class="stat-icon bg-blue">ğŸ‘¥</div>
    <div class="stat-content">
      <div class="stat-value"><%= @clients_count %></div>
      <div class="stat-label">Clients</div>
      <div class="stat-change neutral">Voir la liste â†’</div>
    </div>
  <% end %>

  <%= link_to quotes_admin_user_path(@user), class: "stat-card", style: "text-decoration: none;" do %>
    <div class="stat-icon bg-purple">ğŸ“‹</div>
    <div class="stat-content">
      <div class="stat-value"><%= @quotes_count %></div>
      <div class="stat-label">Devis</div>
      <div class="stat-change neutral">Voir la liste â†’</div>
    </div>
  <% end %>

  <%= link_to invoices_admin_user_path(@user), class: "stat-card", style: "text-decoration: none;" do %>
    <div class="stat-icon bg-green">ğŸ“„</div>
    <div class="stat-content">
      <div class="stat-value"><%= @invoices_count %></div>
      <div class="stat-label">Factures</div>
      <div class="stat-change neutral">Voir la liste â†’</div>
    </div>
  <% end %>

  <%= link_to logs_admin_user_path(@user), class: "stat-card", style: "text-decoration: none;" do %>
    <div class="stat-icon bg-orange">ğŸ“Š</div>
    <div class="stat-content">
      <div class="stat-value"><%= SystemLog.for_user(@user).count %></div>
      <div class="stat-label">Logs</div>
      <div class="stat-change neutral">Voir l'activitÃ© â†’</div>
    </div>
  <% end %>
</div>

<!-- User Details -->
<div class="admin-content-grid">
  <div class="admin-card">
    <div class="card-header">
      <h2>Informations</h2>
      <%= link_to edit_admin_user_path(@user), class: "btn btn-sm btn-outline" do %>
        <span>Modifier</span>
      <% end %>
    </div>
    <div class="details-list">
      <div class="detail-item">
        <span class="detail-label">Nom</span>
        <span class="detail-value"><%= [@user.first_name, @user.last_name].compact.join(' ').presence || '-' %></span>
      </div>
      <div class="detail-item">
        <span class="detail-label">Email</span>
        <span class="detail-value"><%= @user.email.presence || '-' %></span>
      </div>
      <div class="detail-item">
        <span class="detail-label">TÃ©lÃ©phone</span>
        <span class="detail-value"><%= @user.formatted_phone %></span>
      </div>
      <div class="detail-item">
        <span class="detail-label">Langue prÃ©fÃ©rÃ©e</span>
        <span class="detail-value"><%= @user.preferred_language == 'tr' ? 'ğŸ‡¹ğŸ‡· TÃ¼rkÃ§e' : 'ğŸ‡«ğŸ‡· FranÃ§ais' %></span>
      </div>
      <div class="detail-item">
        <span class="detail-label">Statut</span>
        <span class="detail-value"><%= @user.subscription_status %></span>
      </div>
      <div class="detail-item">
        <span class="detail-label">DerniÃ¨re activitÃ©</span>
        <span class="detail-value"><%= @user.last_activity_at ? l(@user.last_activity_at) : '-' %></span>
      </div>
      <div class="detail-item">
        <span class="detail-label">1er message WhatsApp</span>
        <span class="detail-value"><%= @user.first_message_at ? l(@user.first_message_at) : '-' %></span>
      </div>
    </div>
  </div>

  <div class="admin-card">
    <div class="card-header">
      <h2>Entreprise</h2>
    </div>
    <div class="details-list">
      <div class="detail-item">
        <span class="detail-label">Nom de l'entreprise</span>
        <span class="detail-value"><%= @user.company_name.presence || '-' %></span>
      </div>
      <div class="detail-item">
        <span class="detail-label">SIRET</span>
        <span class="detail-value"><%= @user.siret.presence || '-' %></span>
      </div>
      <div class="detail-item">
        <span class="detail-label">NumÃ©ro de TVA</span>
        <span class="detail-value"><%= @user.vat_number.presence || '-' %></span>
      </div>
      <div class="detail-item">
        <span class="detail-label">Adresse</span>
        <span class="detail-value"><%= simple_format(@user.address.to_s) %></span>
      </div>
    </div>
  </div>
</div>

<div class="admin-card" style="margin-top: var(--spacing-xl);">
  <div class="card-header">
    <h2>WhatsApp / Unipile</h2>
  </div>
  <div class="details-list">
    <div class="detail-item">
      <span class="detail-label">Unipile chat id</span>
      <span class="detail-value"><%= @user.unipile_chat_id.presence || '-' %></span>
    </div>
    <div class="detail-item">
      <span class="detail-label">Unipile attendee id</span>
      <span class="detail-value"><%= @user.unipile_attendee_id.presence || '-' %></span>
    </div>
  </div>
</div>

<!-- Quick Actions -->
<div class="admin-card" style="margin-top: var(--spacing-xl);">
  <div class="card-header">
    <h2>Actions rapides</h2>
  </div>
  <div class="quick-actions-grid">
    <%= link_to reset_whatsapp_admin_user_path(@user), method: :post, class: "btn btn-outline btn-block", data: { confirm: "Forcer la reconnexion WhatsApp ?" } do %>
      <span>RÃ©initialiser WhatsApp</span>
    <% end %>

    <%= link_to create_stripe_portal_admin_user_path(@user), method: :post, class: "btn btn-outline btn-block" do %>
      <span>Ouvrir Stripe Portal</span>
    <% end %>

    <%= link_to logs_admin_user_path(@user), class: "btn btn-outline btn-block" do %>
      <span>Voir les logs</span>
    <% end %>

    <%= link_to toggle_bypass_admin_user_path(@user), method: :post, class: "btn btn-outline btn-block", data: { confirm: @user.bypass_subscription ? "DÃ©sactiver l'accÃ¨s gratuit ?" : "Activer l'accÃ¨s gratuit ?" } do %>
      <span><%= @user.bypass_subscription ? 'ğŸš« DÃ©sactiver accÃ¨s gratuit' : 'ğŸ Activer accÃ¨s gratuit' %></span>
    <% end %>
  </div>
</div>
