<% content_for :title, "Stripe - #{@user.display_name}" %>

<div class="admin-page-header">
  <div class="header-with-actions">
    <div>
      <%= link_to "← Retour à l'utilisateur", admin_user_path(@user), class: "back-link" %>
      <h1>Stripe</h1>
      <p class="text-muted"><%= @user.display_name %> • <%= @user.company_name.presence || '-' %></p>
    </div>
    <div class="header-actions">
      <%= link_to admin_user_path(@user), class: "btn btn-outline" do %>
        <span>Retour</span>
      <% end %>
    </div>
  </div>
</div>

<div class="admin-card">
  <div class="card-header">
    <h2>Client Stripe</h2>
    <% if @user.stripe_customer_id.present? %>
      <a href="https://dashboard.stripe.com/customers/<%= @user.stripe_customer_id %>" target="_blank" class="btn btn-sm btn-outline">
        <span>Ouvrir dans Stripe</span>
      </a>
    <% end %>
  </div>

  <div class="details-list">
    <div class="detail-item">
      <span class="detail-label">Customer ID</span>
      <span class="detail-value"><%= @user.stripe_customer_id.present? ? content_tag(:code, @user.stripe_customer_id) : '-' %></span>
    </div>
    <div class="detail-item">
      <span class="detail-label">Email</span>
      <span class="detail-value"><%= @user.email.presence || '-' %></span>
    </div>
    <div class="detail-item">
      <span class="detail-label">Téléphone</span>
      <span class="detail-value"><%= @user.formatted_phone %></span>
    </div>
  </div>

  <% if @user.stripe_customer_id.blank? %>
    <div class="alert alert-warning" style="margin-top: var(--spacing-md);">
      Ce compte n'a pas de <strong>stripe_customer_id</strong>. Impossible d'ouvrir le portail Stripe tant qu'un customer n'a pas été créé.
    </div>
  <% end %>
</div>

<div class="admin-card" style="margin-top: var(--spacing-xl);">
  <div class="card-header">
    <h2>Abonnement</h2>
    <% if @subscription&.stripe_subscription_id.present? %>
      <a href="https://dashboard.stripe.com/subscriptions/<%= @subscription.stripe_subscription_id %>" target="_blank" class="btn btn-sm btn-outline">
        <span>Voir l'abonnement</span>
      </a>
    <% end %>
  </div>

  <% if @subscription.present? %>
    <div class="details-list">
      <div class="detail-item">
        <span class="detail-label">Subscription ID</span>
        <span class="detail-value"><code><%= @subscription.stripe_subscription_id %></code></span>
      </div>
      <div class="detail-item">
        <span class="detail-label">Statut Stripe</span>
        <span class="detail-value"><%= @subscription.status %></span>
      </div>
      <div class="detail-item">
        <span class="detail-label">Statut interne (User)</span>
        <span class="detail-value"><%= @user.subscription_status %></span>
      </div>
      <div class="detail-item">
        <span class="detail-label">Fin période</span>
        <span class="detail-value"><%= @subscription.current_period_end ? l(@subscription.current_period_end) : '-' %></span>
      </div>
      <div class="detail-item">
        <span class="detail-label">Annulation en fin de période</span>
        <span class="detail-value"><%= @subscription.cancel_at_period_end? ? 'Oui' : 'Non' %></span>
      </div>
    </div>
  <% else %>
    <div class="text-muted" style="padding: var(--spacing-lg);">
      Aucun enregistrement d'abonnement (Subscription) trouvé pour cet utilisateur.
    </div>
  <% end %>
</div>

<div class="admin-card" style="margin-top: var(--spacing-xl);">
  <div class="card-header">
    <h2>Factures d'abonnement (Stripe invoices)</h2>
  </div>

  <table class="admin-table">
    <thead>
      <tr>
        <th>Période</th>
        <th>Montant</th>
        <th>Statut</th>
        <th>Invoice ID</th>
        <th>Liens</th>
      </tr>
    </thead>
    <tbody>
      <% @subscription_invoices.each do |inv| %>
        <tr>
          <td><%= inv.period_description || '-' %></td>
          <td><%= inv.amount ? inv.formatted_amount : '-' %></td>
          <td><%= inv.status %></td>
          <td><code><%= inv.stripe_invoice_id %></code></td>
          <td>
            <% if inv.stripe_invoice_url.present? %>
              <a class="btn btn-xs btn-outline" href="<%= inv.stripe_invoice_url %>" target="_blank">URL</a>
            <% end %>
            <% if inv.stripe_invoice_pdf.present? %>
              <a class="btn btn-xs btn-outline" href="<%= inv.stripe_invoice_pdf %>" target="_blank">PDF</a>
            <% end %>
            <% if inv.stripe_invoice_url.blank? && inv.stripe_invoice_pdf.blank? %>
              -
            <% end %>
          </td>
        </tr>
      <% end %>

      <% if @subscription_invoices.empty? %>
        <tr>
          <td colspan="5" class="text-muted">Aucune facture trouvée.</td>
        </tr>
      <% end %>
    </tbody>
  </table>
</div>

<div class="admin-card" style="margin-top: var(--spacing-xl);">
  <div class="card-header">
    <h2>Actions</h2>
  </div>

  <div class="quick-actions-grid">
    <%= link_to create_stripe_portal_admin_user_path(@user), method: :post, class: "btn btn-primary btn-block", data: { disable_with: "Ouverture..." } do %>
      <span>Ouvrir Stripe Customer Portal</span>
    <% end %>

    <% if @user.stripe_customer_id.present? %>
      <a href="https://dashboard.stripe.com/customers/<%= @user.stripe_customer_id %>" target="_blank" class="btn btn-outline btn-block">
        <span>Profil client Stripe</span>
      </a>
    <% end %>

    <% if @subscription&.stripe_subscription_id.present? %>
      <a href="https://dashboard.stripe.com/subscriptions/<%= @subscription.stripe_subscription_id %>" target="_blank" class="btn btn-outline btn-block">
        <span>Abonnement Stripe</span>
      </a>
    <% end %>

    <%= link_to admin_user_path(@user), class: "btn btn-outline btn-block" do %>
      <span>Retour au profil utilisateur</span>
    <% end %>
  </div>
</div>
