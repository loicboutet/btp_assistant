<% content_for :title, "Utilisateurs - Admin" %>

<div class="admin-page-header">
  <div class="header-with-actions">
    <div>
      <h1>Gestion des Utilisateurs</h1>
      <p class="text-muted">GÃ©rez tous les comptes artisans de la plateforme</p>
    </div>
    <div class="header-actions">
      <%= link_to new_admin_user_path, class: "btn btn-primary btn-sm" do %>
        <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
          <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
        </svg>
        <span>CrÃ©er un utilisateur</span>
      <% end %>
    </div>
  </div>
</div>

<!-- Filters & Search -->
<div class="admin-card" style="margin-bottom: var(--spacing-lg);">
  <h3 class="filters-title">Filtres de recherche</h3>

  <%= form_with url: admin_users_path, method: :get, local: true, class: "filters-bar" do %>
    <div class="search-box">
      <%= text_field_tag :q, params[:q], type: :search, placeholder: "Rechercher par entreprise, tÃ©lÃ©phone, SIRET...", class: "form-input" %>
    </div>

    <div class="filter-group">
      <%= select_tag :status,
            options_for_select([
              ["Tous les statuts", ""],
              ["Actifs", "active"],
              ["En attente", "pending"],
              ["Paiement Ã©chouÃ©", "past_due"],
              ["Suspendus/AnnulÃ©s", "canceled"]
            ], params[:status]),
            class: "form-select" %>
    </div>

    <div class="filter-group">
      <%= select_tag :language,
            options_for_select([
              ["Toutes les langues", ""],
              ["FranÃ§ais", "fr"],
              ["Turc", "tr"]
            ], params[:language]),
            class: "form-select" %>
    </div>

    <div class="filter-group">
      <%= select_tag :whatsapp,
            options_for_select([
              ["WhatsApp (Tous)", ""],
              ["ConnectÃ©s", "connected"],
              ["Non connectÃ©s", "disconnected"]
            ], params[:whatsapp]),
            class: "form-select" %>
    </div>

    <div class="filter-actions">
      <%= link_to admin_users_path, class: "btn btn-outline" do %>
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="20" height="20">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
        </svg>
        <span>Effacer</span>
      <% end %>
      <button class="btn btn-primary" type="submit">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="20" height="20">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 3c2.755 0 5.455.232 8.083.678.533.09.917.556.917 1.096v1.044a2.25 2.25 0 01-.659 1.591l-5.432 5.432a2.25 2.25 0 00-.659 1.591v2.927a2.25 2.25 0 01-1.244 2.013L9.75 21v-6.568a2.25 2.25 0 00-.659-1.591L3.659 7.409A2.25 2.25 0 013 5.818V4.774c0-.54.384-1.006.917-1.096A48.32 48.32 0 0112 3z" />
        </svg>
        <span>Filtrer</span>
      </button>
    </div>
  <% end %>
</div>

<!-- Users Table with Scroll Wrapper -->
<div class="admin-card">
  <div class="table-responsive">
    <table class="admin-table">
      <thead>
        <tr>
          <th>Utilisateur</th>
          <th>Entreprise</th>
          <th>Langue</th>
          <th>WhatsApp</th>
          <th>Abonnement</th>
          <th>Documents</th>
          <th>Statut</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <% @users.each do |user| %>
          <% quotes_count = user.quotes.count %>
          <% invoices_count = user.invoices.count %>
          <tr>
            <td data-label="Utilisateur">
              <div class="user-info">
                <div class="user-avatar"><%= (user.company_name.presence || user.phone_number).to_s.first(2).upcase %></div>
                <div>
                  <div class="user-name"><%= user.display_name %></div>
                  <div class="user-email"><%= user.formatted_phone %></div>
                </div>
              </div>
            </td>
            <td data-label="Entreprise">
              <div><%= user.company_name.presence || "-" %></div>
              <div class="text-muted small">SIRET: <%= user.siret.presence || "-" %></div>
            </td>
            <td data-label="Langue">
              <% if user.preferred_language == 'tr' %>
                <span class="badge badge-red">ðŸ‡¹ðŸ‡· TR</span>
              <% else %>
                <span class="badge badge-blue">ðŸ‡«ðŸ‡· FR</span>
              <% end %>
            </td>
            <td data-label="WhatsApp">
              <% if user.unipile_chat_id.present? %>
                <span class="status-badge status-success">ConnectÃ©</span>
              <% else %>
                <span class="status-badge status-warning">Non connectÃ©</span>
              <% end %>
            </td>
            <td data-label="Abonnement">
              <div><%= user.subscription_status %></div>
              <% if (sub = user.subscriptions.order(created_at: :desc).first) %>
                <% if sub.current_period_end.present? %>
                  <div class="text-muted small">Fin pÃ©riode: <%= l(sub.current_period_end.to_date) %></div>
                <% end %>
              <% end %>
            </td>
            <td data-label="Documents">
              <div><%= quotes_count + invoices_count %> docs</div>
              <div class="text-muted small"><%= quotes_count %> devis, <%= invoices_count %> factures</div>
            </td>
            <td data-label="Statut">
              <% css = case user.subscription_status
                     when 'active' then 'status-success'
                     when 'past_due' then 'status-warning'
                     when 'pending' then 'status-warning'
                     when 'canceled' then 'status-danger'
                     else ''
                     end %>
              <span class="status-badge <%= css %>"><%= user.subscription_status %></span>
            </td>
            <td data-label="Actions">
              <div class="action-buttons">
                <%= link_to admin_user_path(user), class: "btn btn-xs btn-outline" do %>
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="14" height="14">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                  </svg>
                  <span>Voir</span>
                <% end %>
              </div>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
</div>

<!-- Pagination -->
<%= render 'shared/pagination', collection: @users || [] %>
