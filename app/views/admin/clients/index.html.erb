<% content_for :title, "Tous les Clients - Admin" %>

<div class="admin-page-header">
  <h1>Tous les Clients</h1>
  <p class="text-muted"><%= Client.count %> clients</p>
</div>

<!-- Filters -->
<div class="admin-card" style="margin-bottom: var(--spacing-lg);">
  <h3 class="filters-title">Filtres de recherche</h3>

  <%= form_with url: admin_clients_path, method: :get, local: true, class: "filters-bar" do %>
    <div class="search-box">
      <%= text_field_tag :q, params[:q], type: :search, placeholder: "Rechercher par nom, SIRET, adresse, entreprise...", class: "form-input" %>
    </div>

    <div class="filter-group">
      <%= select_tag :kind,
            options_for_select([
              ["Tous les types", ""],
              ["Professionnels", "professional"],
              ["Particuliers", "individual"]
            ], params[:kind]),
            class: "form-select" %>
    </div>

    <div class="filter-group">
      <%= select_tag :user_id,
            options_for_select([["Tous les utilisateurs", ""]] + @users_for_filter.map { |u| [u.display_name, u.id] }, params[:user_id]),
            class: "form-select" %>
    </div>

    <div class="filter-actions">
      <%= link_to admin_clients_path, class: "btn btn-outline" do %>
        <span>Effacer</span>
      <% end %>
      <button class="btn btn-primary" type="submit">
        <span>Filtrer</span>
      </button>
    </div>
  <% end %>
</div>

<div class="admin-card">
  <div class="table-responsive" data-controller="table-scroll">
    <table class="admin-table">
      <thead>
        <tr>
          <th>Client</th>
          <th>Type</th>
          <th>Contact</th>
          <th>Utilisateur</th>
          <th>Documents</th>
          <th>CA Total</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <% @clients.each do |client| %>
          <% quotes_count = client.quotes.count %>
          <% invoices_count = client.invoices.count %>
          <tr>
            <td data-label="Client">
              <div class="user-name"><%= client.name %></div>
              <div class="text-muted small"><%= client.siret.present? ? "SIRET: #{client.siret}" : "Particulier" %></div>
            </td>
            <td data-label="Type">
              <% if client.professional? %>
                <span class="badge badge-blue">üè¢ Pro</span>
              <% else %>
                <span class="badge badge-green">üë§ Part.</span>
              <% end %>
            </td>
            <td data-label="Contact">
              <div><%= client.contact_email.presence || '-' %></div>
              <div class="text-muted small"><%= client.contact_phone.presence || '-' %></div>
            </td>
            <td data-label="Utilisateur">
              <div class="user-info-compact">
                <div class="user-avatar-sm"><%= client.user.display_name.to_s.first(2).upcase %></div>
                <span><%= client.user.display_name %></span>
              </div>
            </td>
            <td data-label="Documents">
              <%= quotes_count + invoices_count %> docs
            </td>
            <td data-label="CA" class="font-weight-bold success-text">
              <%= ActionController::Base.helpers.number_to_currency(client.total_paid_amount, unit: '‚Ç¨', format: '%n %u') %>
            </td>
            <td data-label="Actions">
              <%= link_to client_admin_user_path(client.user, client_id: client.id), class: "btn btn-xs btn-outline" do %>
                <span>Voir</span>
              <% end %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
</div>

<%= render 'shared/pagination', collection: @clients %>
