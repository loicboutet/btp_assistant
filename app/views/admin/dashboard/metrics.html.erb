<% content_for :title, "Métriques - Dashboard Admin" %>

<div class="admin-page-header">
  <h1>Métriques & Analytics</h1>
  <p class="text-muted">Statistiques détaillées de l'application</p>
</div>

<!-- Revenue Metrics -->
<div class="admin-card" style="margin-bottom: 3rem;">
  <div class="card-header">
    <h2>Revenus & Abonnements</h2>
  </div>
  <div class="metrics-grid">
    <div class="metric-item" style="background: linear-gradient(135deg, #128C7E 0%, #0d5f54 100%);">
      <div class="metric-label" style="color: #FFFFFF;">MRR (estimé)</div>
      <div class="metric-value large" style="color: #FFFFFF;"><%= format_eur(@mrr_estimated) %></div>
      <div class="metric-trend neutral" style="background-color: rgba(255, 255, 255, 0.2); color: #FFFFFF;">ARR: <%= format_eur(@arr_estimated) %></div>
      <div class="metric-detail" style="color: #FFFFFF;">Basé sur SubscriptionInvoice (paid)
      </div>
    </div>

    <div class="metric-item" style="background: linear-gradient(135deg, #128C7E 0%, #0d5f54 100%);">
      <div class="metric-label" style="color: #FFFFFF;">Abonnements actifs</div>
      <div class="metric-value large" style="color: #FFFFFF;"><%= @subscriptions_by_status['active'] || 0 %></div>
      <div class="metric-trend neutral" style="background-color: rgba(255, 255, 255, 0.2); color: #FFFFFF;">Past due: <%= @subscriptions_by_status['past_due'] || 0 %></div>
      <div class="metric-detail" style="color: #FFFFFF;">Total: <%= @subscriptions_total %></div>
    </div>

    <div class="metric-item" style="background: linear-gradient(135deg, #128C7E 0%, #0d5f54 100%);">
      <div class="metric-label" style="color: #FFFFFF;">Utilisateurs (statut abonnement)</div>
      <div class="metric-value large" style="color: #FFFFFF;"><%= @total_users %></div>
      <div class="metric-trend neutral" style="background-color: rgba(255, 255, 255, 0.2); color: #FFFFFF;">Actifs: <%= @active_users %></div>
      <div class="metric-detail" style="color: #FFFFFF;">Past due: <%= @past_due_users %></div>
    </div>

    <div class="metric-item" style="background: linear-gradient(135deg, #128C7E 0%, #0d5f54 100%);">
      <div class="metric-label" style="color: #FFFFFF;">ARPU (estimé)</div>
      <div class="metric-value large" style="color: #FFFFFF;"><%= format_eur(@arpu_estimated) %></div>
      <div class="metric-trend neutral" style="background-color: rgba(255, 255, 255, 0.2); color: #FFFFFF;">Base: <%= @active_users %> users actifs</div>
      <div class="metric-detail" style="color: #FFFFFF;">(MRR / users actifs)</div>
    </div>
  </div>
</div>

<!-- User Metrics -->
<div class="admin-card" style="margin-bottom: 3rem;">
  <div class="card-header">
    <h2>Utilisateurs & Engagement</h2>
  </div>
  <div class="metrics-grid">
    <div class="metric-item" style="background: linear-gradient(135deg, #00A884 0%, #00856A 100%);">
      <div class="metric-label" style="color: #FFFFFF;">Total utilisateurs</div>
      <div class="metric-value" style="color: #FFFFFF;"><%= @total_users %></div>
      <div class="metric-detail" style="color: #FFFFFF;"><%= @active_users %> actifs, <%= @past_due_users %> past_due</div>
    </div>

    <div class="metric-item" style="background: linear-gradient(135deg, #00A884 0%, #00856A 100%);">
      <div class="metric-label" style="color: #FFFFFF;">Utilisateurs actifs (30j)</div>
      <div class="metric-value" style="color: #FFFFFF;"><%= @active_users_30d %></div>
      <div class="metric-detail" style="color: #FFFFFF;">Basé sur last_activity_at</div>
    </div>

    <div class="metric-item" style="background: linear-gradient(135deg, #00A884 0%, #00856A 100%);">
      <div class="metric-label" style="color: #FFFFFF;">Nouveaux utilisateurs (30j)</div>
      <div class="metric-value" style="color: #FFFFFF;"><%= @new_users_30d %></div>
      <div class="metric-detail" style="color: #FFFFFF;">Créés depuis 30 jours</div>
    </div>

    <div class="metric-item" style="background: linear-gradient(135deg, #00A884 0%, #00856A 100%);">
      <div class="metric-label" style="color: #FFFFFF;">Langues</div>
      <div class="metric-value" style="color: #FFFFFF;">FR: <%= @users_by_language['fr'] || 0 %></div>
      <div class="metric-detail" style="color: #FFFFFF;">TR: <%= @users_by_language['tr'] || 0 %></div>
    </div>
  </div>
</div>

<!-- Document Metrics -->
<div class="admin-card" style="margin-bottom: 3rem;">
  <div class="card-header">
    <h2>Documents générés</h2>
  </div>
  <div class="metrics-grid">
    <div class="metric-item" style="background: linear-gradient(135deg, #10B981 0%, #059669 100%);">
      <div class="metric-label" style="color: #FFFFFF;">Total documents (30j)</div>
      <div class="metric-value" style="color: #FFFFFF;"><%= @documents_30d %></div>
      <div class="metric-detail" style="color: #FFFFFF;"><%= @quotes_30d %> devis, <%= @invoices_30d %> factures</div>
    </div>

    <div class="metric-item" style="background: linear-gradient(135deg, #10B981 0%, #059669 100%);">
      <div class="metric-label" style="color: #FFFFFF;">Docs / user actif (30j)</div>
      <div class="metric-value" style="color: #FFFFFF;"><%= @documents_per_active_user_30d %></div>
      <div class="metric-detail" style="color: #FFFFFF;">(docs 30j / users actifs 30j)</div>
    </div>

    <div class="metric-item" style="background: linear-gradient(135deg, #10B981 0%, #059669 100%);">
      <div class="metric-label" style="color: #FFFFFF;">Aujourd'hui</div>
      <div class="metric-value" style="color: #FFFFFF;"><%= @documents_today %></div>
      <div class="metric-detail" style="color: #FFFFFF;"><%= @quotes_today %> devis, <%= @invoices_today %> factures</div>
    </div>

    <div class="metric-item" style="background: linear-gradient(135deg, #10B981 0%, #059669 100%);">
      <div class="metric-label" style="color: #FFFFFF;">Sur 7 jours</div>
      <div class="metric-value" style="color: #FFFFFF;"><%= @documents_7d %></div>
      <div class="metric-detail" style="color: #FFFFFF;"><%= @quotes_7d %> devis, <%= @invoices_7d %> factures</div>
    </div>
  </div>
</div>

<!-- WhatsApp & Integration Metrics -->
<div class="admin-card" style="margin-bottom: 3rem;">
  <div class="card-header">
    <h2>WhatsApp & Intégrations</h2>
  </div>
  <div class="metrics-grid">
    <div class="metric-item" style="background: linear-gradient(135deg, #25D366 0%, #1F9D55 100%);">
      <div class="metric-label" style="color: #FFFFFF;">Comptes WhatsApp connectés</div>
      <div class="metric-value" style="color: #FFFFFF;"><%= @whatsapp_connected_users %></div>
      <div class="metric-detail" style="color: #FFFFFF;"><%= @whatsapp_connected_users_rate %>% du total</div>
    </div>

    <div class="metric-item" style="background: linear-gradient(135deg, #25D366 0%, #1F9D55 100%);">
      <div class="metric-label" style="color: #FFFFFF;">Messages (30j)</div>
      <div class="metric-value" style="color: #FFFFFF;"><%= @messages_30d %></div>
      <div class="metric-detail" style="color: #FFFFFF;">Aujourd'hui: <%= @messages_today %></div>
    </div>

    <div class="metric-item" style="background: linear-gradient(135deg, #25D366 0%, #1F9D55 100%);">
      <div class="metric-label" style="color: #FFFFFF;">Messages vocaux transcrits (30j)</div>
      <div class="metric-value" style="color: #FFFFFF;"><%= @voice_transcribed_30d %></div>
      <div class="metric-detail" style="color: #FFFFFF;">Audio avec transcription non vide</div>
    </div>

    <div class="metric-item" style="background: linear-gradient(135deg, #25D366 0%, #1F9D55 100%);">
      <div class="metric-label" style="color: #FFFFFF;">Taux de succès IA (30j)</div>
      <div class="metric-value" style="color: #FFFFFF;"><%= format_percent(@ai_success_rate_30d) %></div>
      <div class="metric-detail" style="color: #FFFFFF;">Messages entrants traités sans erreur</div>
    </div>
  </div>
</div>

<!-- System Performance (via SystemLog heuristics) -->
<div class="admin-card" style="margin-bottom: 3rem;">
  <div class="card-header">
    <h2>Performance système</h2>
  </div>
  <div class="metrics-grid">
    <div class="metric-item" style="background: linear-gradient(135deg, #14B8A6 0%, #0D9488 100%);">
      <div class="metric-label" style="color: #FFFFFF;">Webhooks Unipile (24h)</div>
      <div class="metric-value" style="color: #FFFFFF;"><%= @unipile_webhook_stats_24h[:total] %></div>
      <div class="metric-detail" style="color: #FFFFFF;">Succès: <%= format_percent(@unipile_webhook_stats_24h[:success_rate]) %> (<%= @unipile_webhook_stats_24h[:success] %>/<%= @unipile_webhook_stats_24h[:total] %>)</div>
    </div>

    <div class="metric-item" style="background: linear-gradient(135deg, #14B8A6 0%, #0D9488 100%);">
      <div class="metric-label" style="color: #FFFFFF;">Webhooks Stripe (24h)</div>
      <div class="metric-value" style="color: #FFFFFF;"><%= @stripe_webhook_stats_24h[:total] %></div>
      <div class="metric-detail" style="color: #FFFFFF;">Succès: <%= format_percent(@stripe_webhook_stats_24h[:success_rate]) %> (<%= @stripe_webhook_stats_24h[:success] %>/<%= @stripe_webhook_stats_24h[:total] %>)</div>
    </div>

    <div class="metric-item" style="background: linear-gradient(135deg, #14B8A6 0%, #0D9488 100%);">
      <div class="metric-label" style="color: #FFFFFF;">Webhooks (global, 24h)</div>
      <div class="metric-value" style="color: #FFFFFF;"><%= @webhook_stats_24h[:total] %></div>
      <div class="metric-detail" style="color: #FFFFFF;">Succès: <%= format_percent(@webhook_success_rate_24h) %> (<%= @webhook_stats_24h[:success] %>/<%= @webhook_stats_24h[:total] %>)</div>
    </div>

    <div class="metric-item" style="background: linear-gradient(135deg, #14B8A6 0%, #0D9488 100%);">
      <div class="metric-label" style="color: #FFFFFF;">Note</div>
      <div class="metric-value" style="color: #FFFFFF;">—</div>
      <div class="metric-detail" style="color: #FFFFFF;">Les webhooks sont mesurés via SystemLog (pas de table dédiée)</div>
    </div>
  </div>
</div>
