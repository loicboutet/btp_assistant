<% content_for :title, "Dashboard Admin - Devis WhatsApp" %>

<div class="admin-page-header">
  <h1>Tableau de bord Admin</h1>
  <p class="text-muted">Vue d'ensemble de l'application</p>
</div>

<!-- Stats Cards -->
<div class="stats-grid">
  <div class="stat-card">
    <div class="stat-icon bg-blue">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="32" height="32">
        <path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-3.07M12 6.375a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zm8.25 2.25a2.625 2.25 0 11-5.25 0 2.625 2.25 0 015.25 0z" />
      </svg>
    </div>
    <div class="stat-content">
      <div class="stat-value"><%= @active_users %></div>
      <div class="stat-label">Utilisateurs actifs</div>
      <div class="stat-change neutral"><%= @active_users %> / <%= @total_users %> (total)</div>
    </div>
  </div>

  <div class="stat-card">
    <div class="stat-icon bg-green">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="32" height="32">
        <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 8.25h19.5M2.25 9h19.5m-16.5 5.25h6m-6 2.25h3m-3.75 3h15a2.25 2.25 0 002.25-2.25V6.75A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25v10.5A2.25 2.25 0 004.5 19.5z" />
      </svg>
    </div>
    <div class="stat-content">
      <div class="stat-value"><%= format_eur(@mrr_estimated) %></div>
      <div class="stat-label">MRR estimé</div>
      <div class="stat-change neutral">ARPU: <%= format_eur(@arpu_estimated) %></div>
    </div>
  </div>

  <div class="stat-card">
    <div class="stat-icon bg-purple">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="32" height="32">
        <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
      </svg>
    </div>
    <div class="stat-content">
      <div class="stat-value"><%= @documents_total %></div>
      <div class="stat-label">Documents générés</div>
      <div class="stat-change neutral"><%= @documents_7d %> ces 7 derniers jours</div>
    </div>
  </div>

  <div class="stat-card">
    <div class="stat-icon bg-orange">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="32" height="32">
        <path stroke-linecap="round" stroke-linejoin="round" d="M13.19 8.688a4.5 4.5 0 011.242 7.244l-4.5 4.5a4.5 4.5 0 01-6.364-6.364l1.757-1.757m13.35-.622l1.757-1.757a4.5 4.5 0 00-6.364-6.364l-4.5 4.5a4.5 4.5 0 001.242 7.244" />
      </svg>
    </div>
    <div class="stat-content">
      <div class="stat-value"><%= format_percent(@webhook_success_rate_24h) %></div>
      <div class="stat-label">Webhooks (24h) - succès</div>
      <div class="stat-change neutral"><%= @webhook_stats_24h[:success] %> succès / <%= @webhook_stats_24h[:failed] %> échecs (total: <%= @webhook_stats_24h[:total] %>)</div>
    </div>
  </div>
</div>

<!-- Recent Activity -->
<div class="admin-content-grid">
  <div class="admin-card">
    <div class="card-header">
      <h2>Activité récente</h2>
      <%= link_to admin_system_logs_path, class: "btn btn-sm btn-outline" do %>
        Voir tout
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" width="16" height="16" style="display: inline-block; vertical-align: middle; margin-left: 4px;">
          <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5L21 12m0 0l-7.5 7.5M21 12H3" />
        </svg>
      <% end %>
    </div>

    <div class="activity-list">
      <% if @recent_logs.present? %>
        <% @recent_logs.each do |log| %>
          <div class="activity-item">
            <div class="activity-icon <%= activity_color_class_for(log) %>"><%= activity_icon_for(log) %></div>
            <div class="activity-content">
              <div class="activity-title"><%= activity_title_for(log) %></div>
              <div class="activity-meta"><%= activity_meta_for(log) %></div>
            </div>
          </div>
        <% end %>
      <% else %>
        <div class="text-muted">Aucune activité récente.</div>
      <% end %>
    </div>
  </div>

  <div class="admin-card">
    <div class="card-header">
      <h2>Abonnements en alerte</h2>
      <%= link_to overdue_admin_subscriptions_path, class: "btn btn-sm btn-outline" do %>
        Voir tout
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" width="16" height="16" style="display: inline-block; vertical-align: middle; margin-left: 4px;">
          <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5L21 12m0 0l-7.5 7.5M21 12H3" />
        </svg>
      <% end %>
    </div>

    <div class="alert-list">
      <% if @overdue_subscriptions_list.present? %>
        <% @overdue_subscriptions_list.each do |sub| %>
          <div class="alert-item warning">
            <div class="alert-icon">⚠️</div>
            <div class="alert-content">
              <div class="alert-title">Paiement en retard</div>
              <div class="alert-meta">
                <%= sub.user&.display_name || "Utilisateur ##{sub.user_id}" %>
                <% if sub.days_remaining.present? %>
                  - <%= sub.days_remaining %> jours restants
                <% end %>
              </div>
            </div>
            <%= link_to "Voir", admin_subscription_path(sub), class: "btn btn-sm btn-outline" %>
          </div>
        <% end %>
      <% else %>
        <div class="text-muted">Aucun abonnement en alerte.</div>
      <% end %>
    </div>
  </div>
</div>

<!-- Quick Stats -->
<div class="admin-card" style="margin-top: var(--spacing-xl);">
  <div class="card-header">
    <h2>Statistiques rapides</h2>
    <%= link_to admin_metrics_path, class: "btn btn-sm btn-primary" do %>
      Analytics détaillées
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" width="16" height="16" style="display: inline-block; vertical-align: middle; margin-left: 4px;">
        <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5L21 12m0 0l-7.5 7.5M21 12H3" />
      </svg>
    <% end %>
  </div>

  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-icon bg-blue">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="32" height="32">
          <path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-3.07M12 6.375a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zm8.25 2.25a2.625 2.25 0 11-5.25 0 2.625 2.25 0 015.25 0z" />
        </svg>
      </div>
      <div class="stat-content">
        <div class="stat-value"><%= @new_users_7d %></div>
        <div class="stat-label">Nouveaux utilisateurs (7j)</div>
        <div class="stat-change neutral">Cette semaine</div>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon bg-green">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="32" height="32">
          <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 8.25h19.5M2.25 9h19.5m-16.5 5.25h6m-6 2.25h3m-3.75 3h15a2.25 2.25 0 002.25-2.25V6.75A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25v10.5A2.25 2.25 0 004.5 19.5z" />
        </svg>
      </div>
      <div class="stat-content">
        <div class="stat-value"><%= @active_subscriptions %></div>
        <div class="stat-label">Abonnements actifs</div>
        <div class="stat-change neutral"><%= @past_due_subscriptions %> en retard</div>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon bg-purple">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="32" height="32">
          <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
        </svg>
      </div>
      <div class="stat-content">
        <div class="stat-value"><%= @quotes_this_month %></div>
        <div class="stat-label">Devis créés (mois)</div>
        <div class="stat-change neutral">Ce mois</div>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon bg-orange">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="32" height="32">
          <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
        </svg>
      </div>
      <div class="stat-content">
        <div class="stat-value"><%= @invoices_this_month %></div>
        <div class="stat-label">Factures créées (mois)</div>
        <div class="stat-change neutral">Ce mois</div>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon bg-blue">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="32" height="32">
          <path stroke-linecap="round" stroke-linejoin="round" d="M8.625 12a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H8.25m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H12m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0h-.375M21 12c0 4.556-4.03 8.25-9 8.25a9.764 9.764 0 01-2.555-.337A5.972 5.972 0 015.41 20.97a5.969 5.969 0 01-.474-.065 4.48 4.48 0 00.978-2.025c.09-.457-.133-.901-.467-1.226C3.93 16.178 3 14.189 3 12c0-4.556 4.03-8.25 9-8.25s9 3.694 9 8.25z" />
        </svg>
      </div>
      <div class="stat-content">
        <div class="stat-value"><%= @messages_this_month %></div>
        <div class="stat-label">Messages WhatsApp (mois)</div>
        <div class="stat-change neutral"><%= @messages_24h %> sur 24h</div>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon bg-green">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="32" height="32">
          <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
      </div>
      <div class="stat-content">
        <div class="stat-value"><%= @active_users_30d %></div>
        <div class="stat-label">Utilisateurs actifs (30j)</div>
        <div class="stat-change neutral">Basé sur last_activity_at</div>
      </div>
    </div>
  </div>
</div>
