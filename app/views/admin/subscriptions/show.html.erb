<% content_for :title, "D√©tails Abonnement - Admin" %>

<div class="admin-page-header">
  <div style="display: flex; justify-content: space-between; align-items: center; gap: var(--spacing-md);">
    <div>
      <h1>D√©tails de l'abonnement</h1>
      <p class="text-muted">Abonnement #<%= @subscription.id %></p>
    </div>
    <div style="display:flex; gap: var(--spacing-sm);">
      <%= link_to edit_admin_subscription_path(@subscription), class: "btn btn-primary" do %>
        √âditer
      <% end %>
      <%= link_to admin_subscriptions_path, class: "btn btn-outline" do %>
        ‚Üê Retour aux abonnements
      <% end %>
    </div>
  </div>
</div>

<!-- User Information -->
<div class="admin-card">
  <div class="card-header">
    <h2>Informations utilisateur</h2>
  </div>
  <div style="padding: var(--spacing-lg);">
    <div class="user-info" style="margin-bottom: var(--spacing-lg);">
      <div class="user-avatar" style="width: 60px; height: 60px; font-size: 24px;"><%= (@subscription.user.company_name.presence || @subscription.user.phone_number).to_s.first(2).upcase %></div>
      <div>
        <div class="user-name" style="font-size: 1.25rem; font-weight: 600;"><%= @subscription.user.display_name %></div>
        <div class="user-email"><%= @subscription.user.formatted_phone %></div>
        <%= link_to admin_user_path(@subscription.user.id), class: "btn btn-sm btn-outline", style: "margin-top: var(--spacing-sm);" do %>
          üë§ Voir le profil complet
        <% end %>
      </div>
    </div>
  </div>
</div>

<!-- Subscription Details -->
<div class="admin-card" style="margin-top: var(--spacing-lg);">
  <div class="card-header">
    <h2>D√©tails de l'abonnement</h2>
  </div>
  <div style="padding: var(--spacing-lg);">
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: var(--spacing-lg);">
      <div>
        <div class="text-muted small">Statut</div>
        <div style="margin-top: var(--spacing-xs);">
          <span class="status-badge"><%= @subscription.status %></span>
        </div>
      </div>
      <div>
        <div class="text-muted small">P√©riode actuelle</div>
        <div style="font-weight: 600; margin-top: var(--spacing-xs);">
          <%= @subscription.current_period_start ? l(@subscription.current_period_start.to_date) : '-' %>
          ‚Üí
          <%= @subscription.current_period_end ? l(@subscription.current_period_end.to_date) : '-' %>
        </div>
      </div>
      <div>
        <div class="text-muted small">Annulation en fin de p√©riode ?</div>
        <div style="font-weight: 600; margin-top: var(--spacing-xs);"><%= @subscription.cancel_at_period_end? ? 'Oui' : 'Non' %></div>
      </div>
      <div>
        <div class="text-muted small">Cr√©√© le</div>
        <div style="font-weight: 600; margin-top: var(--spacing-xs);"><%= l(@subscription.created_at.to_date) %></div>
      </div>
    </div>
  </div>
</div>

<!-- Stripe Information -->
<div class="admin-card" style="margin-top: var(--spacing-lg);">
  <div class="card-header">
    <h2>Informations Stripe</h2>
  </div>
  <div style="padding: var(--spacing-lg);">
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: var(--spacing-lg);">
      <div>
        <div class="text-muted small">Stripe Customer ID</div>
        <div style="font-weight: 600; margin-top: var(--spacing-xs);"><code><%= @subscription.user.stripe_customer_id.presence || '-' %></code></div>
      </div>
      <div>
        <div class="text-muted small">Stripe Subscription ID</div>
        <div style="font-weight: 600; margin-top: var(--spacing-xs);"><code><%= @subscription.stripe_subscription_id %></code></div>
      </div>
    </div>
  </div>
</div>

<!-- Payment History -->
<div class="admin-card" style="margin-top: var(--spacing-lg);">
  <div class="card-header">
    <h2>Historique des paiements (Stripe invoices)</h2>
  </div>
  <table class="admin-table">
    <thead>
      <tr>
        <th>P√©riode</th>
        <th>Invoice</th>
        <th>Montant</th>
        <th>Statut</th>
      </tr>
    </thead>
    <tbody>
      <% @subscription_invoices.each do |inv| %>
        <tr>
          <td><%= inv.period_description || '-' %></td>
          <td style="font-family: monospace;"><%= inv.stripe_invoice_id %></td>
          <td class="font-weight-bold"><%= inv.formatted_amount %></td>
          <td><span class="status-badge"><%= inv.status %></span></td>
        </tr>
      <% end %>
      <% if @subscription_invoices.empty? %>
        <tr>
          <td colspan="4" class="text-muted">Aucune facture Stripe enregistr√©e.</td>
        </tr>
      <% end %>
    </tbody>
  </table>
</div>

<!-- Actions -->
<div class="admin-card" style="margin-top: var(--spacing-lg);">
  <div class="card-header">
    <h2>Actions</h2>
  </div>
  <div style="padding: var(--spacing-lg);">
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: var(--spacing-md);">
      <%= link_to create_stripe_portal_admin_user_path(@subscription.user), method: :post, class: "btn btn-primary" do %>
        üí≥ Acc√©der au portail Stripe
      <% end %>
      <%= link_to admin_user_path(@subscription.user), class: "btn btn-outline" do %>
        üë§ Voir l'utilisateur
      <% end %>
    </div>
  </div>
</div>
