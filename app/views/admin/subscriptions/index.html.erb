<% content_for :title, "Abonnements - Admin" %>

<div class="admin-page-header">
  <div style="display:flex; justify-content: space-between; align-items: center; gap: var(--spacing-md);">
    <div>
      <h1>Gestion des abonnements</h1>
      <p class="text-muted"><%= @active_count %> actifs • <%= @past_due_count %> en retard • <%= @canceled_count %> annulés</p>
    </div>
    <div>
      <%= link_to new_admin_subscription_path, class: "btn btn-primary btn-sm" do %>
        + Créer un abonnement
      <% end %>
    </div>
  </div>
</div>

<!-- Filters -->
<div class="admin-card" style="margin-bottom: var(--spacing-lg);">
  <h3 class="filters-title">Filtres de recherche</h3>
  <%= form_with url: admin_subscriptions_path, method: :get, local: true, class: "filters-bar" do %>
    <div class="search-box">
      <%= text_field_tag :q, params[:q], type: :search, placeholder: "Rechercher par entreprise, customer/subscription id...", class: "form-input" %>
    </div>
    <div class="filter-group">
      <%= select_tag :status,
            options_for_select([
              ["Tous les statuts", ""],
              ["Actifs", "active"],
              ["En retard", "past_due"],
              ["Annulés", "canceled"],
              ["Unpaid", "unpaid"],
              ["Incomplete", "incomplete"]
            ], params[:status]),
            class: "form-select" %>
    </div>
    <div class="filter-actions">
      <%= link_to admin_subscriptions_path, class: "btn btn-outline" do %>
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="20" height="20">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
        </svg>
        <span>Effacer</span>
      <% end %>
      <%= link_to overdue_admin_subscriptions_path, class: "btn btn-primary" do %>
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="20" height="20">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 3c2.755 0 5.455.232 8.083.678.533.09.917.556.917 1.096v1.044a2.25 2.25 0 01-.659 1.591l-5.432 5.432a2.25 2.25 0 00-.659 1.591v2.927a2.25 2.25 0 01-1.244 2.013L9.75 21v-6.568a2.25 2.25 0 00-.659-1.591L3.659 7.409A2.25 2.25 0 013 5.818V4.774c0-.54.384-1.006.917-1.096A48.32 48.32 0 0112 3z" />
        </svg>
        <span>Abonnements en retard</span>
      <% end %>
      <button class="btn btn-primary" type="submit" style="display:none"></button>
    </div>
  <% end %>
</div>

<!-- Subscriptions Table -->
<div class="admin-card">
  <div class="table-responsive" data-controller="table-scroll">
    <table class="admin-table">
      <thead>
        <tr>
          <th>Utilisateur</th>
          <th>Statut</th>
          <th>Stripe IDs</th>
          <th>Date début</th>
          <th>Fin période</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <% @subscriptions.each do |sub| %>
          <tr>
            <td data-label="Utilisateur">
              <div class="user-info">
                <div class="user-avatar"><%= (sub.user.company_name.presence || sub.user.phone_number).to_s.first(2).upcase %></div>
                <div>
                  <div class="user-name"><%= sub.user.display_name %></div>
                  <div class="user-email"><%= sub.user.formatted_phone %></div>
                </div>
              </div>
            </td>
            <td data-label="Statut">
              <% css = case sub.status
                     when 'active' then 'status-success'
                     when 'past_due' then 'status-warning'
                     when 'canceled', 'unpaid' then 'status-danger'
                     else 'status-warning'
                     end %>
              <span class="status-badge <%= css %>"><%= sub.status %></span>
            </td>
            <td data-label="Stripe IDs">
              <div class="text-muted small"><%= sub.user.stripe_customer_id.presence || '-' %></div>
              <div class="text-muted small"><%= sub.stripe_subscription_id %></div>
            </td>
            <td data-label="Date début"><%= sub.current_period_start ? l(sub.current_period_start.to_date) : '-' %></td>
            <td data-label="Fin période"><%= sub.current_period_end ? l(sub.current_period_end.to_date) : '-' %></td>
            <td data-label="Actions">
              <div class="action-buttons">
                <%= link_to admin_subscription_path(sub), class: "btn btn-xs btn-outline" do %>
                  Voir
                <% end %>
                <%= link_to edit_admin_subscription_path(sub), class: "btn btn-xs btn-outline" do %>
                  Éditer
                <% end %>
                <%= link_to admin_user_path(sub.user), class: "btn btn-xs btn-outline" do %>
                  Profil
                <% end %>
              </div>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
</div>

<%= render 'shared/pagination', collection: @subscriptions %>
