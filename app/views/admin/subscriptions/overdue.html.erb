<% content_for :title, "Abonnements en retard - Admin" %>

<div class="admin-page-header">
  <h1>Abonnements en retard</h1>
  <p class="text-muted"><%= @subscriptions.count %> abonnements affichés (page courante)</p>
</div>

<div class="admin-card" style="margin-bottom: var(--spacing-lg);">
  <h3 class="filters-title">Recherche</h3>
  <%= form_with url: overdue_admin_subscriptions_path, method: :get, local: true, class: "filters-bar" do %>
    <div class="search-box">
      <%= text_field_tag :q, params[:q], type: :search, placeholder: "Rechercher par entreprise, customer/subscription id...", class: "form-input" %>
    </div>
    <div class="filter-actions">
      <%= link_to overdue_admin_subscriptions_path, class: "btn btn-outline" do %>
        <span>Effacer</span>
      <% end %>
      <button class="btn btn-primary" type="submit">Rechercher</button>
    </div>
  <% end %>
</div>

<div class="admin-card">
  <div class="table-responsive" data-controller="table-scroll">
    <table class="admin-table">
      <thead>
        <tr>
          <th>Utilisateur</th>
          <th>Statut</th>
          <th>Fin période</th>
          <th>Stripe IDs</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <% @subscriptions.each do |sub| %>
          <tr>
            <td>
              <div class="user-info">
                <div class="user-avatar"><%= (sub.user.company_name.presence || sub.user.phone_number).to_s.first(2).upcase %></div>
                <div>
                  <div class="user-name"><%= sub.user.display_name %></div>
                  <div class="user-email"><%= sub.user.formatted_phone %></div>
                </div>
              </div>
            </td>
            <td><span class="status-badge status-warning"><%= sub.status %></span></td>
            <td><%= sub.current_period_end ? l(sub.current_period_end.to_date) : '-' %></td>
            <td>
              <div class="text-muted small"><%= sub.user.stripe_customer_id.presence || '-' %></div>
              <div class="text-muted small"><%= sub.stripe_subscription_id %></div>
            </td>
            <td>
              <div class="action-buttons">
                <%= link_to admin_user_path(sub.user), class: "btn btn-xs btn-outline" do %>
                  Profil
                <% end %>
                <%= link_to admin_subscription_path(sub), class: "btn btn-xs btn-outline" do %>
                  Détails
                <% end %>
              </div>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
</div>

<%= render 'shared/pagination', collection: @subscriptions %>
