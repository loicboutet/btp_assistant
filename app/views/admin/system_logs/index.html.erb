<% content_for :title, "Logs système" %>

<div class="admin-page-header">
  <h1>Logs système</h1>
  <p class="text-muted">Audit & évènements applicatifs (SystemLog)</p>
</div>

<div class="admin-card" style="margin-bottom: var(--spacing-lg);">
  <h3 class="filters-title">Filtres</h3>

  <%= form_with url: admin_system_logs_path, method: :get, local: true, class: "filters-bar" do |f| %>
    <div class="search-box">
      <%= f.search_field :q, value: @filters[:q], placeholder: "Rechercher (event/description)...", class: "form-input" %>
    </div>

    <div class="filter-group">
      <%= f.select :log_type, options_for_select([['Tous les types', '']] + @log_types.map { |t| [t, t] }, @filters[:log_type]), {}, class: "form-select" %>
    </div>

    <div class="filter-group">
      <%= f.select :event, options_for_select([['Tous les events', '']] + @events.map { |e| [e, e] }, @filters[:event]), {}, class: "form-select" %>
    </div>

    <div class="filter-group">
      <%= f.select :user_id, options_for_select([['Tous les utilisateurs', '']] + @users_for_filter.map { |u| ["##{u.id} - #{u.display_name}", u.id] }, @filters[:user_id]), {}, class: "form-select" %>
    </div>

    <div class="filter-group">
      <%= f.select :admin_id, options_for_select([['Tous les admins', '']] + @admins_for_filter.map { |a| [a.email, a.id] }, @filters[:admin_id]), {}, class: "form-select" %>
    </div>

    <div class="filter-group">
      <%= f.date_field :from, value: @filters[:from], class: "form-input" %>
    </div>

    <div class="filter-group">
      <%= f.date_field :to, value: @filters[:to], class: "form-input" %>
    </div>

    <div class="filter-actions">
      <%= link_to "Effacer", admin_system_logs_path, class: "btn btn-outline" %>
      <%= f.submit "Filtrer", class: "btn btn-primary" %>
    </div>
  <% end %>
</div>

<div class="admin-card">
  <table class="admin-table">
    <thead>
      <tr>
        <th>Horodatage</th>
        <th>Type</th>
        <th>Event</th>
        <th>Utilisateur</th>
        <th>Admin</th>
        <th>Description</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <% @system_logs.each do |log| %>
        <tr>
          <td class="text-nowrap"><%= l(log.created_at, format: :short) rescue log.created_at %></td>
          <td>
            <span class="badge <%= log.log_type_badge_class %>"><%= log.log_type %></span>
          </td>
          <td class="text-nowrap"><%= log.event %></td>
          <td>
            <% if log.user %>
              <%= link_to "##{log.user_id} - #{log.user.display_name}", admin_user_path(log.user_id), class: "link" %>
            <% else %>
              <span class="text-muted">—</span>
            <% end %>
          </td>
          <td>
            <% if log.admin_user %>
              <span class="text-muted"><%= log.admin_user.email %></span>
            <% else %>
              <span class="text-muted">—</span>
            <% end %>
          </td>
          <td class="text-muted small"><%= log.description.to_s.truncate(120) %></td>
          <td>
            <%= link_to "Détails", admin_system_log_path(log), class: "btn btn-xs btn-outline" %>
          </td>
        </tr>
      <% end %>

      <% if @system_logs.empty? %>
        <tr>
          <td colspan="7" class="text-muted">Aucun log</td>
        </tr>
      <% end %>
    </tbody>
  </table>
</div>

<% if @total_pages > 1 %>
  <div class="pagination">
    <% if @current_page > 1 %>
      <%= link_to "← Précédent", admin_system_logs_path(request.query_parameters.merge(page: @current_page - 1)), class: "btn btn-outline" %>
    <% else %>
      <button class="btn btn-outline" disabled>Précédent</button>
    <% end %>

    <span class="pagination-info">Page <%= @current_page %> sur <%= @total_pages %></span>

    <% if @current_page < @total_pages %>
      <%= link_to "Suivant →", admin_system_logs_path(request.query_parameters.merge(page: @current_page + 1)), class: "btn btn-outline" %>
    <% else %>
      <button class="btn btn-outline" disabled>Suivant</button>
    <% end %>
  </div>
<% end %>
