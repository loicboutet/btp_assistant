<% content_for :title, "Toutes les Factures - Admin" %>

<div class="admin-page-header">
  <h1>Toutes les Factures</h1>
  <p class="text-muted"><%= Invoice.count %> factures</p>
</div>

<!-- Filters -->
<div class="admin-card" style="margin-bottom: var(--spacing-lg);">
  <h3 class="filters-title">Filtres de recherche</h3>

  <%= form_with url: admin_invoices_path, method: :get, local: true, class: "filters-bar" do %>
    <div class="search-box">
      <%= text_field_tag :q, params[:q], type: :search, placeholder: "Rechercher par numéro, client, entreprise...", class: "form-input" %>
    </div>

    <div class="filter-group">
      <%= select_tag :status,
            options_for_select([
              ["Tous les statuts", ""],
              ["Brouillon", "draft"],
              ["Envoyée", "sent"],
              ["Payée", "paid"],
              ["En retard", "overdue"],
              ["Annulée", "canceled"]
            ], params[:status]),
            class: "form-select" %>
    </div>

    <div class="filter-group">
      <%= select_tag :user_id,
            options_for_select([["Tous les utilisateurs", ""]] + @users_for_filter.map { |u| [u.display_name, u.id] }, params[:user_id]),
            class: "form-select" %>
    </div>

    <div class="filter-group">
      <%= select_tag :period,
            options_for_select([
              ["Toutes les périodes", ""],
              ["Aujourd'hui", "today"],
              ["Cette semaine", "week"],
              ["Ce mois", "month"],
              ["Ce trimestre", "quarter"]
            ], params[:period]),
            class: "form-select" %>
    </div>

    <div class="filter-actions">
      <%= link_to admin_invoices_path, class: "btn btn-outline" do %>
        <span>Effacer</span>
      <% end %>
      <button class="btn btn-primary" type="submit">
        <span>Filtrer</span>
      </button>
    </div>
  <% end %>
</div>

<div class="admin-card">
  <div class="table-responsive" data-controller="table-scroll">
    <table class="admin-table">
      <thead>
        <tr>
          <th>Numéro</th>
          <th>Utilisateur</th>
          <th>Client</th>
          <th>Date émission</th>
          <th>Échéance</th>
          <th>Montant TTC</th>
          <th>Statut</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <% @invoices.each do |inv| %>
          <tr>
            <td data-label="Numéro"><%= inv.invoice_number %></td>
            <td data-label="Utilisateur">
              <div class="user-info-compact">
                <div class="user-avatar-sm"><%= inv.user.display_name.to_s.first(2).upcase %></div>
                <span><%= inv.user.display_name %></span>
              </div>
            </td>
            <td data-label="Client">
              <div><%= inv.client.name %></div>
              <div class="text-muted small"><%= inv.client.siret.present? ? "SIRET: #{inv.client.siret}" : "Particulier" %></div>
            </td>
            <td data-label="Date"><%= l(inv.issue_date) %></td>
            <td data-label="Échéance"><%= inv.due_date ? l(inv.due_date) : '-' %></td>
            <td data-label="Montant" class="font-weight-bold"><%= inv.formatted_total %></td>
            <td data-label="Statut"><span class="status-badge"><%= inv.status %></span></td>
            <td data-label="Actions">
              <%= link_to invoice_admin_user_path(inv.user, invoice_id: inv.id), class: "btn btn-xs btn-outline" do %>
                <span>Voir</span>
              <% end %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
</div>

<%= render 'shared/pagination', collection: @invoices %>
