<% content_for :title, "Rejouer le Webhook" %>

<div class="admin-page-header">
  <%= link_to admin_webhooks_path, class: "back-link" do %>
    ← Retour aux webhooks
  <% end %>
  <h1>Rejouer le webhook</h1>
  <p class="text-muted">Ce rejeu est limité aux échecs de traitement WhatsApp (whatsapp_message_processing_failed).</p>
</div>

<div class="admin-card" style="margin-bottom: var(--spacing-lg);">
  <div class="card-header">
    <h2>Événement</h2>
    <span class="badge <%= @webhook.log_type_badge_class %>"><%= @webhook.log_type %></span>
  </div>

  <div class="details-list">
    <div class="detail-item">
      <span class="detail-label">SystemLog ID</span>
      <span class="detail-value">#<%= @webhook.id %></span>
    </div>

    <div class="detail-item">
      <span class="detail-label">Event</span>
      <span class="detail-value"><%= @webhook.event %></span>
    </div>

    <div class="detail-item">
      <span class="detail-label">Horodatage</span>
      <span class="detail-value"><%= l(@webhook.created_at, format: :long) rescue @webhook.created_at %></span>
    </div>

    <div class="detail-item">
      <span class="detail-label">Utilisateur</span>
      <span class="detail-value">
        <% if @webhook.user %>
          <%= link_to "##{@webhook.user_id} - #{@webhook.user.display_name}", admin_user_path(@webhook.user_id) %>
        <% else %>
          —
        <% end %>
      </span>
    </div>

    <div class="detail-item">
      <span class="detail-label">Description</span>
      <span class="detail-value"><%= @webhook.description.presence || '—' %></span>
    </div>
  </div>
</div>

<div class="admin-card" style="margin-bottom: var(--spacing-lg);">
  <div class="card-header">
    <h2>Métadonnées (JSON)</h2>
  </div>

  <div style="background-color: var(--bg-light); padding: var(--spacing-md); border-radius: var(--radius-md); overflow-x: auto;">
    <pre style="margin:0; white-space: pre-wrap; word-wrap: break-word;"><%= JSON.pretty_generate(@webhook.metadata || {}) %></pre>
  </div>
</div>

<div class="alert alert-warning" style="margin-bottom: var(--spacing-lg);">
  <strong>⚠️ Attention :</strong> le rejeu remet le message en "non traité" et relance <code>ProcessWhatsappMessageJob</code>.
  Cela peut renvoyer un message à l'utilisateur.
</div>

<div class="admin-card">
  <div class="card-header">
    <h2>Actions</h2>
  </div>

  <div class="quick-actions-grid">
    <%= button_to replay_admin_webhook_path(@webhook), method: :post, class: "btn btn-primary btn-block", data: { confirm: "Confirmer le rejeu ?" } do %>
      Rejouer maintenant
    <% end %>

    <%= link_to "Annuler", admin_webhooks_path, class: "btn btn-outline btn-block" %>
  </div>
</div>
