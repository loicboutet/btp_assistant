<% content_for :title, "Webhooks - Admin" %>

<div class="admin-page-header">
  <h1>Surveillance des Webhooks</h1>
  <p class="text-muted">Vue basée sur SystemLog (Stripe + Unipile)</p>
</div>

<div class="admin-card" style="margin-bottom: var(--spacing-lg);">
  <h3 class="filters-title">Filtres</h3>

  <%= form_with url: admin_webhooks_path, method: :get, local: true, class: "filters-bar" do |f| %>
    <div class="filter-group">
      <%= f.select :source, options_for_select([['Toutes les sources', ''], ['Unipile', 'unipile'], ['Stripe', 'stripe']], @filters[:source]), {}, class: "form-select" %>
    </div>

    <div class="filter-group">
      <%= f.select :status, options_for_select([['Tous statuts', ''], ['Succès', 'success'], ['Erreur/Warning', 'error']], @filters[:status]), {}, class: "form-select" %>
    </div>

    <div class="filter-group">
      <%= f.select :user_id, options_for_select([['Tous les utilisateurs', '']] + @users_for_filter.map { |u| ["##{u.id} - #{u.display_name}", u.id] }, @filters[:user_id]), {}, class: "form-select" %>
    </div>

    <div class="filter-group">
      <%= f.date_field :from, value: @filters[:from], class: "form-input" %>
    </div>

    <div class="filter-group">
      <%= f.date_field :to, value: @filters[:to], class: "form-input" %>
    </div>

    <div class="filter-actions">
      <%= link_to "Effacer", admin_webhooks_path, class: "btn btn-outline" %>
      <%= f.submit "Filtrer", class: "btn btn-primary" %>
    </div>
  <% end %>
</div>

<div class="admin-card">
  <div class="card-header">
    <h2>Activité</h2>
  </div>

  <div class="table-responsive">
    <table class="admin-table">
      <thead>
        <tr>
          <th>Horodatage</th>
          <th>Source</th>
          <th>Event</th>
          <th>Utilisateur</th>
          <th>Détails</th>
          <th>Statut</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <% @webhooks.each do |log| %>
          <% source = log.event.to_s.start_with?('stripe_') ? 'stripe' : (log.event.to_s.start_with?('whatsapp_') ? 'unipile' : 'unknown') %>
          <% status_badge = case log.log_type
                           when 'error' then 'status-badge status-danger'
                           when 'warning' then 'status-badge status-warning'
                           else 'status-badge status-success'
                           end %>

          <tr class="<%= 'row-danger' if log.log_type == 'error' %>">
            <td class="text-nowrap"><%= l(log.created_at, format: :short) rescue log.created_at %></td>
            <td>
              <% if source == 'stripe' %>
                <span class="badge badge-purple">Stripe</span>
              <% elsif source == 'unipile' %>
                <span class="badge badge-green">Unipile</span>
              <% else %>
                <span class="badge">?</span>
              <% end %>
            </td>
            <td class="text-nowrap"><%= log.event %></td>
            <td>
              <% if log.user %>
                <%= link_to "##{log.user_id} - #{log.user.display_name}", admin_user_path(log.user_id) %>
              <% else %>
                <span class="text-muted">—</span>
              <% end %>
            </td>
            <td class="text-muted small"><%= log.description.to_s.truncate(120) %></td>
            <td><span class="<%= status_badge %>"><%= log.log_type %></span></td>
            <td style="white-space: nowrap;">
              <%= link_to "Log", admin_system_log_path(log), class: "btn btn-xs btn-outline" %>
              <% if replay_allowed?(log) %>
                <%= link_to "Rejouer", replay_admin_webhook_path(log), class: "btn btn-xs btn-primary" %>
              <% else %>
                <button class="btn btn-xs btn-outline" disabled>Rejouer</button>
              <% end %>
            </td>
          </tr>
        <% end %>

        <% if @webhooks.empty? %>
          <tr>
            <td colspan="7" class="text-muted">Aucun événement</td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
</div>

<% if @total_pages > 1 %>
  <div class="pagination">
    <% if @current_page > 1 %>
      <%= link_to "← Précédent", admin_webhooks_path(request.query_parameters.merge(page: @current_page - 1)), class: "btn btn-outline" %>
    <% else %>
      <button class="btn btn-outline" disabled>Précédent</button>
    <% end %>

    <span class="pagination-info">Page <%= @current_page %> sur <%= @total_pages %></span>

    <% if @current_page < @total_pages %>
      <%= link_to "Suivant →", admin_webhooks_path(request.query_parameters.merge(page: @current_page + 1)), class: "btn btn-outline" %>
    <% else %>
      <button class="btn btn-outline" disabled>Suivant</button>
    <% end %>
  </div>
<% end %>
