<% content_for :title, t('client.profile.title') %>
<% content_for :page_title, t('client.profile.title') %>
<% content_for :active_page, :profile %>
<% content_for :back_path, client_dashboard_path %>

<!-- Content -->
<main class="p-6 max-w-2xl mx-auto">
  
  <!-- Company Info -->
  <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-4">
    <div class="text-center mb-6">
      <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-3">
        <span class="text-2xl font-bold text-green-600"><%= current_user.display_name.first(2).upcase %></span>
      </div>
      <h2 class="text-xl font-bold text-gray-900"><%= current_user.display_name %></h2>
      <p class="text-gray-600"><%= current_user.formatted_phone %></p>
    </div>
    
    <div class="space-y-4 text-sm">
      <div class="flex justify-between py-2 border-b border-gray-100">
        <span class="text-gray-600">SIRET</span>
        <span class="font-medium text-gray-900"><%= current_user.siret.presence || '‚Äî' %></span>
      </div>
      <div class="flex justify-between py-2 border-b border-gray-100">
        <span class="text-gray-600"><%= t('client.profile.address') %></span>
        <span class="font-medium text-gray-900 text-right max-w-[60%]"><%= current_user.address.presence || '‚Äî' %></span>
      </div>
      <div class="flex justify-between py-2 border-b border-gray-100">
        <span class="text-gray-600"><%= t('client.profile.vat_number') %></span>
        <span class="font-medium text-gray-900"><%= current_user.vat_number.presence || '‚Äî' %></span>
      </div>
      <div class="flex justify-between py-2">
        <span class="text-gray-600"><%= t('client.profile.language') %></span>
        <span class="font-medium text-gray-900">
          <%= current_user.french? ? 'üá´üá∑ Fran√ßais' : 'üáπüá∑ T√ºrk√ße' %>
        </span>
      </div>
    </div>
    
    <p class="mt-4 text-xs text-gray-500 text-center italic">
      üí¨ <%= t('client.profile.edit_hint') %>
    </p>
  </div>

  <!-- Subscription -->
  <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-4">
    <h3 class="font-semibold text-gray-900 mb-4"><%= t('client.profile.subscription') %></h3>
    
    <div class="flex items-center justify-between mb-4">
      <div>
        <p class="text-sm text-gray-600"><%= t('client.profile.status') %></p>
        <% case current_user.subscription_status %>
        <% when 'active' %>
          <p class="font-semibold text-green-600">‚úÖ <%= t('client.profile.status_active') %></p>
        <% when 'past_due' %>
          <p class="font-semibold text-yellow-600">‚ö†Ô∏è <%= t('client.profile.status_past_due') %></p>
        <% when 'canceled' %>
          <p class="font-semibold text-red-600">‚ùå <%= t('client.profile.status_canceled') %></p>
        <% else %>
          <p class="font-semibold text-gray-600">‚è≥ <%= t('client.profile.status_pending') %></p>
        <% end %>
      </div>
      <% if @subscription.present? && @subscription.current_period_end.present? %>
        <div class="text-right">
          <p class="text-sm text-gray-600">
            <%= @subscription.will_cancel? ? t('client.profile.ends_on') : t('client.profile.next_payment') %>
          </p>
          <p class="font-medium text-gray-900"><%= l(@subscription.current_period_end.to_date, format: :long) %></p>
        </div>
      <% end %>
    </div>
    
    <% if current_user.stripe_customer_id.present? %>
      <%= button_to client_billing_portal_path,
                    method: :post,
                    class: "block w-full bg-gray-100 hover:bg-gray-200 text-gray-800 font-medium py-3 px-4 rounded-lg text-center transition" do %>
        <%= t('client.profile.manage_subscription') %>
      <% end %>
    <% end %>
  </div>

  <% if @subscription_invoices.any? %>
    <!-- Subscription Invoices -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 mb-4 overflow-hidden">
      <h3 class="font-semibold text-gray-900 p-4 border-b border-gray-200"><%= t('client.profile.subscription_invoices') %></h3>
      <div class="divide-y divide-gray-200">
        <% @subscription_invoices.each do |invoice| %>
          <div class="p-4 flex justify-between items-center">
            <div>
              <p class="font-medium text-gray-900"><%= invoice.invoice_number || "‚Äî" %></p>
              <p class="text-xs text-gray-500">
                <% if invoice.period_start.present? && invoice.period_end.present? %>
                  <%= l(invoice.period_start, format: :short) %> - <%= l(invoice.period_end, format: :short) %>
                <% end %>
              </p>
            </div>
            <div class="text-right">
              <p class="font-bold text-gray-900"><%= number_to_currency(invoice.amount, unit: '‚Ç¨', format: '%n %u') %></p>
              <% if invoice.stripe_invoice_pdf.present? %>
                <%= link_to t('client.profile.download'), invoice.stripe_invoice_pdf, target: "_blank", class: "text-xs text-green-600 hover:underline" %>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>

  <!-- Quick Help -->
  <div class="bg-green-50 rounded-xl border border-green-200 p-6">
    <h3 class="font-semibold text-gray-900 mb-2">üí¨ <%= t('client.profile.need_help') %></h3>
    <p class="text-sm text-gray-700 mb-4">
      <%= t('client.profile.help_text') %>
    </p>
    <div class="space-y-2 text-xs text-gray-700 mb-4">
      <p>‚Ä¢ <strong>"cr√©er un devis"</strong> - <%= t('client.profile.command_quote') %></p>
      <p>‚Ä¢ <strong>"mes devis"</strong> - <%= t('client.profile.command_quotes') %></p>
      <p>‚Ä¢ <strong>"aide"</strong> - <%= t('client.profile.command_help') %></p>
    </div>
    <a href="https://wa.me/" target="_blank"
       class="block w-full bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-4 rounded-lg text-center transition">
      üü¢ <%= t('client.profile.open_whatsapp') %>
    </a>
  </div>

</main>
