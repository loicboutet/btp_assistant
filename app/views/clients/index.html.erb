<% content_for :title, "Mes Clients - Devis WhatsApp" %>
<% content_for :page_title, "Mes clients" %>
<% content_for :back_path, client_dashboard_path %>
<% content_for :active_page, :clients %>

<!-- Content -->
<main class="p-4 max-w-2xl mx-auto">
  
  <!-- Simple Search -->
  <div class="mb-4">
    <input type="text" 
           id="search-input"
           placeholder="ğŸ” Rechercher..." 
           class="w-full px-5 py-4 text-base bg-white rounded-full border-2 border-gray-200 focus:outline-none focus:border-green-500 shadow-sm">
  </div>

  <!-- List of Clients -->
  <div id="clients-list" class="space-y-3">
    
    <% if @clients&.any? %>
      <% @clients.each do |client| %>
        <%= link_to client_path(client.id), 
                    class: "block client-item",
                    data: { 
                      search: "#{client.name} #{client.email}".downcase
                    } do %>
          <div class="bg-white rounded-xl p-5 shadow-sm border border-gray-200 hover:shadow-md transition">
            <div class="flex justify-between items-start mb-3">
              <div class="flex-1">
                <h3 class="font-semibold text-gray-800 text-lg"><%= client.name %></h3>
                <p class="text-sm text-gray-600"><%= client.address&.split(',')&.last&.strip || client.email %></p>
                <% if client.siret.present? %>
                  <p class="text-xs text-gray-500 mt-1">SIRET: <%= client.siret %></p>
                <% end %>
              </div>
              <div class="text-right">
                <p class="text-sm text-gray-600">Documents</p>
                <p class="text-xl font-bold text-gray-900"><%= client.quotes.count + client.invoices.count %></p>
              </div>
            </div>
            
            <div class="flex justify-between items-center pt-3 border-t border-gray-100">
              <div class="flex space-x-4 text-xs text-gray-600">
                <span>ğŸ“„ <%= client.quotes.count %> devis</span>
                <span>ğŸ§¾ <%= client.invoices.count %> factures</span>
              </div>
              <div>
                <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                </svg>
              </div>
            </div>
          </div>
        <% end %>
      <% end %>
    <% else %>
      <div class="bg-white rounded-xl p-12 text-center shadow-sm border border-gray-200">
        <div class="text-6xl mb-4">ğŸ‘¥</div>
        <h3 class="text-lg font-semibold text-gray-900 mb-2">Aucun client</h3>
        <p class="text-gray-600 mb-6">Vos clients crÃ©Ã©s via WhatsApp apparaÃ®tront ici.</p>
        <a href="https://wa.me/33612000000?text=nouveau client" 
           class="inline-flex items-center px-6 py-3 bg-green-600 text-white font-medium rounded-lg hover:bg-green-700">
          ğŸŸ¢ Ajouter un client sur WhatsApp
        </a>
      </div>
    <% end %>
    
    <div id="no-results" class="hidden bg-white rounded-xl p-12 text-center shadow-sm border border-gray-200">
      <div class="text-6xl mb-4">ğŸ”</div>
      <h3 class="text-lg font-semibold text-gray-900 mb-2">Aucun rÃ©sultat</h3>
      <p class="text-gray-600">Essayez de modifier votre recherche.</p>
    </div>
  </div>

  <!-- Hint -->
  <div class="mt-8 text-center">
    <p class="text-sm text-gray-500">
      ğŸ’¬ Pour ajouter un client, envoyez <strong>"nouveau client"</strong> sur WhatsApp
    </p>
  </div>

</main>

<script>
  function initClientSearch() {
    document.getElementById('search-input')?.addEventListener('input', (e) => {
      const searchTerm = e.target.value.toLowerCase();
      const items = document.querySelectorAll('.client-item');
      let visibleCount = 0;

      items.forEach(item => {
        const searchText = item.dataset.search;
        const matches = searchTerm === '' || searchText.includes(searchTerm);
        
        item.classList.toggle('hidden', !matches);
        if (matches) visibleCount++;
      });

      document.getElementById('no-results')?.classList.toggle('hidden', visibleCount > 0);
    });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initClientSearch);
  } else {
    initClientSearch();
  }
  document.addEventListener('turbo:load', initClientSearch);
  document.addEventListener('turbo:render', initClientSearch);
</script>
