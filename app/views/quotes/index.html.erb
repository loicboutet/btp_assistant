<% content_for :title, "Mes Devis - Devis WhatsApp" %>
<% content_for :page_title, "Mes devis" %>
<% content_for :back_path, client_dashboard_path %>
<% content_for :active_page, :quotes %>

<!-- Content -->
<main class="p-4 max-w-2xl mx-auto">
  
  <!-- Simple Search -->
  <div class="mb-4">
    <input type="text" 
           id="quote-search"
           placeholder="ğŸ” Rechercher..." 
           class="w-full px-5 py-4 text-base bg-white rounded-full border-2 border-gray-200 focus:outline-none focus:border-green-500 shadow-sm">
  </div>

  <!-- Simple Filters -->
  <div class="grid grid-cols-3 gap-3 mb-6">
    <div class="relative">
      <button type="button" data-filter="client" class="filter-btn w-full flex flex-col items-center justify-center py-4 px-3 bg-white rounded-2xl border-2 border-gray-200 shadow-sm hover:border-green-500 active:bg-gray-50 transition">
        <span class="text-2xl mb-1">ğŸ“„</span>
        <span class="text-xs font-semibold text-center leading-tight filter-label">Tous les clients</span>
      </button>
      
      <div data-dropdown="client" class="dropdown hidden absolute top-full mt-2 left-0 right-0 bg-white rounded-xl shadow-xl border-2 border-gray-200 py-2 z-20 max-h-60 overflow-y-auto">
        <button type="button" data-value="all" class="block w-full text-left px-4 py-3 text-sm hover:bg-gray-100 font-semibold text-green-600">Tous les clients</button>
        <div class="border-t border-gray-100 my-1"></div>
        <% @quotes.map(&:client_name).uniq.sort.each do |client| %>
          <button type="button" data-value="<%= client %>" class="block w-full text-left px-4 py-3 text-sm hover:bg-gray-100"><%= client %></button>
        <% end %>
      </div>
    </div>

    <div class="relative">
      <button type="button" data-filter="month" class="filter-btn w-full flex flex-col items-center justify-center py-4 px-3 bg-white rounded-2xl border-2 border-gray-200 shadow-sm hover:border-green-500 active:bg-gray-50 transition">
        <span class="text-2xl mb-1">ğŸ“…</span>
        <span class="text-xs font-semibold text-center leading-tight filter-label">Tous les mois</span>
      </button>
      
      <div data-dropdown="month" class="dropdown hidden absolute top-full mt-2 left-0 right-0 bg-white rounded-xl shadow-xl border-2 border-gray-200 py-2 z-20 max-h-60 overflow-y-auto">
        <button type="button" data-value="all" class="block w-full text-left px-4 py-3 text-sm hover:bg-gray-100 font-semibold text-green-600">Tous les mois</button>
        <div class="border-t border-gray-100 my-1"></div>
        <% @quotes.group_by { |q| q.created_at.strftime('%Y-%m') }.keys.sort.reverse.each do |month| %>
          <% date = Date.parse("#{month}-01") %>
          <button type="button" data-value="<%= month %>" data-label="<%= l(date, format: '%B %Y') %>" class="block w-full text-left px-4 py-3 text-sm hover:bg-gray-100"><%= l(date, format: '%B %Y') %></button>
        <% end %>
      </div>
    </div>

    <div class="relative">
      <button type="button" data-filter="status" class="filter-btn w-full flex flex-col items-center justify-center py-4 px-3 bg-white rounded-2xl border-2 border-gray-200 shadow-sm hover:border-green-500 active:bg-gray-50 transition">
        <span class="text-2xl mb-1">ğŸ·ï¸</span>
        <span class="text-xs font-semibold text-center leading-tight filter-label">Tous</span>
      </button>
      
      <div data-dropdown="status" class="dropdown hidden absolute top-full mt-2 left-0 right-0 bg-white rounded-xl shadow-xl border-2 border-gray-200 py-2 z-20">
        <button type="button" data-value="all" class="block w-full text-left px-4 py-3 text-sm hover:bg-gray-100 font-semibold text-green-600">Tous</button>
        <div class="border-t border-gray-100 my-1"></div>
        <button type="button" data-value="draft" data-short="Brouillon" class="block w-full text-left px-4 py-3 text-sm hover:bg-gray-100">ğŸ“ Brouillon</button>
        <button type="button" data-value="sent" data-short="EnvoyÃ©" class="block w-full text-left px-4 py-3 text-sm hover:bg-gray-100">ğŸ“¤ EnvoyÃ©</button>
        <button type="button" data-value="accepted" data-short="AcceptÃ©" class="block w-full text-left px-4 py-3 text-sm hover:bg-gray-100">âœ… AcceptÃ©</button>
        <button type="button" data-value="rejected" data-short="RefusÃ©" class="block w-full text-left px-4 py-3 text-sm hover:bg-gray-100">âŒ RefusÃ©</button>
      </div>
    </div>
  </div>

  <!-- Active Filters -->
  <div id="active-filters" class="mb-4 hidden">
    <div class="flex flex-wrap gap-2 items-center">
      <span class="text-sm text-gray-600 font-semibold">Filtres:</span>
      <div id="badges-container"></div>
      <button type="button" id="clear-all" class="text-sm text-red-600 hover:text-red-700 font-semibold underline">Tout effacer</button>
    </div>
  </div>

  <!-- List -->
  <div class="space-y-3">
    <% @quotes.each do |quote| %>
      <%= link_to quote_path(quote.id), 
                  class: "block quote-item",
                  data: { 
                    client: quote.client_name,
                    month: quote.created_at.strftime('%Y-%m'),
                    status: quote.status,
                    search: "#{quote.number} #{quote.client_name}".downcase
                  } do %>
        <div class="bg-white rounded-xl p-5 shadow-sm border border-gray-200 hover:shadow-md transition">
          <div class="flex justify-between items-start mb-3">
            <div>
              <h3 class="font-semibold text-gray-800 text-lg"><%= quote.number %></h3>
              <p class="text-sm text-gray-600"><%= quote.client_name %></p>
              <p class="text-xs text-gray-500 mt-1"><%= l(quote.created_at, format: :short) %></p>
            </div>
            <span class="px-3 py-1 bg-green-100 text-green-800 text-xs font-medium rounded-full">
              <%= quote.status.humanize %>
            </span>
          </div>
          <div class="pt-3 border-t border-gray-100">
            <p class="text-2xl font-bold text-gray-900"><%= number_to_currency(quote.amount, unit: "", precision: 2) %> â‚¬</p>
          </div>
        </div>
      <% end %>
    <% end %>
    
    <div id="no-results" class="hidden bg-white rounded-xl p-12 text-center shadow-sm border border-gray-200">
      <div class="text-6xl mb-4">ğŸ”</div>
      <h3 class="text-lg font-semibold text-gray-900 mb-2">Aucun rÃ©sultat</h3>
      <p class="text-gray-600">Essayez de modifier vos filtres.</p>
    </div>
  </div>

  <div class="mt-8 text-center">
    <p class="text-sm text-gray-500">ğŸ’¬ Pour crÃ©er un devis, envoyez <strong>"crÃ©er un devis"</strong> sur WhatsApp</p>
  </div>

</main>

<script>
  document.addEventListener('turbo:load', function() {
    const filters = { client: 'all', month: 'all', status: 'all', search: '' };

    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', function(e) {
        e.stopPropagation();
        const type = this.dataset.filter;
        document.querySelectorAll('.dropdown').forEach(d => {
          d.classList.toggle('hidden', d.dataset.dropdown !== type);
        });
      });
    });

    document.querySelectorAll('.dropdown button').forEach(btn => {
      btn.addEventListener('click', function(e) {
        e.stopPropagation();
        const dropdown = this.closest('.dropdown');
        const type = dropdown.dataset.dropdown;
        const value = this.dataset.value;
        
        filters[type] = value;
        
        const filterBtn = document.querySelector(`[data-filter="${type}"]`);
        const label = filterBtn.querySelector('.filter-label');
        
        if (value === 'all') {
          label.textContent = type === 'client' ? 'Tous les clients' : type === 'month' ? 'Tous les mois' : 'Tous';
        } else {
          label.textContent = this.dataset.short || this.dataset.label || value;
        }
        
        dropdown.classList.add('hidden');
        applyFilters();
      });
    });

    document.getElementById('quote-search')?.addEventListener('input', function(e) {
      filters.search = e.target.value.toLowerCase();
      applyFilters();
    });

    document.addEventListener('click', () => {
      document.querySelectorAll('.dropdown').forEach(d => d.classList.add('hidden'));
    });

    document.getElementById('clear-all')?.addEventListener('click', function() {
      filters.client = filters.month = filters.status = 'all';
      filters.search = '';
      document.querySelector('[data-filter="client"] .filter-label').textContent = 'Tous les clients';
      document.querySelector('[data-filter="month"] .filter-label').textContent = 'Tous les mois';
      document.querySelector('[data-filter="status"] .filter-label').textContent = 'Tous';
      document.getElementById('quote-search').value = '';
      applyFilters();
    });

    function applyFilters() {
      let visible = 0;
      document.querySelectorAll('.quote-item').forEach(item => {
        const match = 
          (filters.client === 'all' || item.dataset.client === filters.client) &&
          (filters.month === 'all' || item.dataset.month === filters.month) &&
          (filters.status === 'all' || item.dataset.status === filters.status) &&
          (filters.search === '' || item.dataset.search.includes(filters.search));
        
        item.style.display = match ? 'block' : 'none';
        if (match) visible++;
      });

      document.getElementById('no-results').style.display = visible === 0 ? 'block' : 'none';
      updateBadges();
    }

    function updateBadges() {
      const hasFilters = filters.client !== 'all' || filters.month !== 'all' || filters.status !== 'all';
      document.getElementById('active-filters').classList.toggle('hidden', !hasFilters);
    }
  });
</script>
