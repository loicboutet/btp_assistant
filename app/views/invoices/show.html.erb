<% content_for :title, "Facture - Devis WhatsApp" %>
<% content_for :page_title, "Facture" %>
<% content_for :back_path, invoices_path %>
<% content_for :active_page, :invoices %>

<!-- Content -->
<main class="p-4 max-w-3xl mx-auto">
  
  <!-- Invoice Header Card -->
  <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-4">
    <div class="flex justify-between items-start mb-4">
      <div>
        <h2 class="text-2xl font-bold text-gray-900"><%= @invoice&.number || "FACT-2025-XXX" %></h2>
        <p class="text-gray-600"><%= @invoice&.client&.name || "Client" %></p>
        <p class="text-sm text-gray-500"><%= l(@invoice&.created_at || Time.current, format: :long) %></p>
      </div>
      <% 
        status_class = case @invoice&.status
        when 'paid'
          'bg-green-100 text-green-800'
        when 'overdue'
          'bg-red-100 text-red-800'
        else
          'bg-yellow-100 text-yellow-800'
        end
      %>
      <span class="px-4 py-2 <%= status_class %> font-medium rounded-full">
        <%= @invoice&.status&.humanize || "En attente" %>
      </span>
    </div>
    
    <!-- Actions -->
    <div class="flex gap-2">
      <%= link_to invoice_pdf_invoice_path(@invoice&.id || params[:id]), class: "flex-1 bg-gray-100 hover:bg-gray-200 text-gray-800 font-medium py-3 px-4 rounded-lg text-center transition", target: "_blank" do %>
        üìÑ T√©l√©charger PDF
      <% end %>
      <%= button_to invoice_path(@invoice&.id || params[:id]), method: :delete, data: { turbo_method: :delete, turbo_confirm: "√ätes-vous s√ªr de vouloir supprimer cette facture ?" }, class: "flex-1 bg-red-600 hover:bg-red-700 text-white font-medium py-3 px-4 rounded-lg text-center transition" do %>
        üóëÔ∏è Supprimer
      <% end %>
    </div>
    
    <!-- Mark as Paid -->
    <% if @invoice&.status != 'paid' %>
      <div class="mt-3">
        <%= button_to update_invoice_status_invoice_path(@invoice&.id || params[:id]), method: :patch, params: { status: 'paid' }, class: "w-full bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-4 rounded-lg transition" do %>
          ‚úÖ Marquer comme pay√©e
        <% end %>
      </div>
    <% end %>
  </div>

  <!-- Client Info -->
  <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-4">
    <h3 class="font-semibold text-gray-900 mb-4">Client</h3>
    <div class="text-sm space-y-2 text-gray-700">
      <p><strong><%= @invoice&.client&.name || "Client Name" %></strong></p>
      <p><%= @invoice&.client&.address || "Adresse client" %></p>
      <% if @invoice&.client&.siret.present? %>
        <p class="text-gray-600">SIRET: <%= @invoice.client.siret %></p>
      <% end %>
    </div>
  </div>

  <!-- Payment Info -->
  <% if @invoice&.due_date.present? %>
    <% 
      due_date = @invoice.due_date.is_a?(Date) ? @invoice.due_date : @invoice.due_date.to_date
      today = Date.current
      days_remaining = (due_date - today).to_i
      
      alert_class = if days_remaining < 0
        'bg-red-50 border-red-200'
      elsif days_remaining < 7
        'bg-orange-50 border-orange-200'
      else
        'bg-yellow-50 border-yellow-200'
      end
      
      icon_color = if days_remaining < 0
        'text-red-600'
      elsif days_remaining < 7
        'text-orange-600'
      else
        'text-yellow-600'
      end
    %>
    <div class="<%= alert_class %> rounded-xl border p-4 mb-4">
      <div class="flex items-center space-x-2">
        <span class="<%= icon_color %>">‚è∞</span>
        <div>
          <p class="text-sm font-medium text-gray-900">
            √âch√©ance: <%= l(due_date, format: :long) %>
          </p>
          <p class="text-xs text-gray-600">
            <% if days_remaining < 0 %>
              En retard de <%= days_remaining.abs %> jour<%= days_remaining.abs > 1 ? 's' : '' %>
            <% elsif days_remaining == 0 %>
              √Ä payer aujourd'hui
            <% else %>
              <%= days_remaining %> jour<%= days_remaining > 1 ? 's' : '' %> restant<%= days_remaining > 1 ? 's' : '' %>
            <% end %>
          </p>
        </div>
      </div>
    </div>
  <% end %>

  <!-- Line Items -->
  <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-4">
    <h3 class="font-semibold text-gray-900 mb-4">D√©tails</h3>
    
    <div class="space-y-3">
      <% if @invoice&.items&.any? %>
        <% @invoice.items.each do |item| %>
          <div class="pb-3 border-b border-gray-100">
            <div class="flex justify-between items-start mb-1">
              <p class="font-medium text-gray-900"><%= item.description %></p>
              <p class="font-bold text-gray-900"><%= number_to_currency(item.total, unit: "", precision: 2) %> ‚Ç¨</p>
            </div>
            <div class="flex justify-between text-sm text-gray-600">
              <span><%= item.quantity %> √ó <%= number_to_currency(item.unit_price, unit: "", precision: 2) %> ‚Ç¨</span>
            </div>
          </div>
        <% end %>
      <% else %>
        <div class="py-3 border-b border-gray-100">
          <div class="flex justify-between items-start mb-1">
            <p class="font-medium text-gray-900">Installation √©lectrique compl√®te</p>
            <p class="font-bold text-gray-900">3 000,00 ‚Ç¨</p>
          </div>
          <div class="text-sm text-gray-600">1 √ó 3 000,00 ‚Ç¨</div>
        </div>
        
        <div class="py-3 border-b border-gray-100">
          <div class="flex justify-between items-start mb-1">
            <p class="font-medium text-gray-900">Plomberie sanitaire</p>
            <p class="font-bold text-gray-900">2 000,00 ‚Ç¨</p>
          </div>
          <div class="text-sm text-gray-600">1 √ó 2 000,00 ‚Ç¨</div>
        </div>
      <% end %>
    </div>

    <!-- Totals -->
    <div class="mt-6 pt-4 border-t-2 border-gray-300 space-y-2">
      <div class="flex justify-between text-gray-700">
        <span>Sous-total HT</span>
        <span><%= number_to_currency(@invoice&.subtotal || 5000, unit: "", precision: 2) %> ‚Ç¨</span>
      </div>
      <div class="flex justify-between text-gray-700">
        <span>TVA (20%)</span>
        <span><%= number_to_currency(@invoice&.tax_amount || 1000, unit: "", precision: 2) %> ‚Ç¨</span>
      </div>
      <div class="flex justify-between text-xl font-bold text-gray-900 pt-2 border-t border-gray-200">
        <span>Total TTC</span>
        <span class="text-green-600"><%= number_to_currency(@invoice&.total || 6000, unit: "", precision: 2) %> ‚Ç¨</span>
      </div>
    </div>
  </div>

  <!-- Notes -->
  <% if @invoice&.notes.present? %>
    <div class="bg-blue-50 rounded-xl border border-blue-200 p-6">
      <h3 class="font-semibold text-gray-900 mb-2">Notes</h3>
      <p class="text-sm text-gray-700 whitespace-pre-wrap"><%= @invoice.notes %></p>
    </div>
  <% end %>

</main>
